<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copertec System - Configuratore v3.0</title>
    <!-- Librerie Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --cavatorta-green: #059669;
            --cavatorta-green-dark: #047857;
            --cavatorta-blue: #1d4ed8;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
            --red-500: #ef4444;
            --red-100: #fee2e2;
            --amber-500: #f59e0b;
            --amber-100: #fef3c7;
            --emerald-500: #10b981;
            --emerald-100: #d1fae5;
            --purple-500: #8b5cf6;
            --purple-100: #ede9fe;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.5;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Header Professionale */
        .header {
            background: linear-gradient(135deg, var(--cavatorta-green) 0%, var(--cavatorta-green-dark) 50%, var(--cavatorta-blue) 100%);
            border-radius: 16px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.25);
            overflow: hidden;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 30px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo svg { flex-shrink: 0; }

        .header-text h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: white;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .header-text span {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.85);
            display: block;
            margin-top: 4px;
        }

        .header-badges {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .badge-cert {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .badge-version {
            background: white;
            color: var(--cavatorta-green);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .header-subtitle {
            background: rgba(0,0,0,0.15);
            padding: 12px 30px;
            color: rgba(255,255,255,0.9);
            font-size: 0.85rem;
            text-align: center;
        }

        /* Sezioni Collapsibili */
        details.collapsible-section {
            margin-top: 16px;
        }

        details.collapsible-section summary {
            cursor: pointer;
            padding: 12px 16px;
            background: var(--gray-100);
            border-radius: 8px;
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            transition: background 0.2s;
            list-style: none;
        }

        details.collapsible-section summary::-webkit-details-marker {
            display: none;
        }

        details.collapsible-section summary::before {
            content: '▶';
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        details.collapsible-section[open] summary::before {
            transform: rotate(90deg);
        }

        details.collapsible-section summary:hover {
            background: var(--gray-200);
        }

        details.collapsible-section[open] summary {
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
        }

        details.collapsible-section .details-content {
            padding: 16px;
            background: white;
            border: 1px solid var(--gray-200);
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        /* Sezioni */
        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray-100);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 0.875rem; font-weight: 500; color: var(--gray-700); }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--cavatorta-green);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        /* Tabella */
        .table-container { overflow-x: auto; margin-top: 16px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        thead { background: var(--gray-50); }

        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
            white-space: nowrap;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
        }

        tbody tr:hover { background: var(--gray-50); }

        td input, td select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.875rem;
        }

        td input:focus, td select:focus {
            outline: none;
            border-color: var(--cavatorta-green);
        }

        td input[type="number"] { width: 70px; }
        td input.input-qty { width: 55px; text-align: center; }
        td input.input-wide { width: 90px; }
        td input.input-name { width: 120px; }

        td input[readonly] {
            background: var(--gray-50);
            color: var(--gray-700);
            font-weight: 600;
            border-color: transparent;
        }

        /* Badge */
        .badge-copertec {
            background: var(--cavatorta-green);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-coperplax {
            background: var(--cavatorta-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Stati */
        .status-valid { color: var(--emerald-500); font-weight: 600; }
        .status-error { color: var(--red-500); font-weight: 600; font-size: 0.8rem; }
        .status-warning { color: var(--amber-500); font-weight: 600; }
        .status-choice { color: var(--purple-500); font-weight: 600; }

        .choice-note {
            background: var(--purple-100);
            border: 1px solid var(--purple-500);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            color: var(--purple-500);
        }

        /* Bottoni */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: var(--cavatorta-green); color: white; }
        .btn-primary:hover { background: var(--cavatorta-green-dark); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-300); }
        .btn-danger { background: var(--red-500); color: white; padding: 6px 10px; font-size: 0.8rem; }

        .actions-row { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }

        /* BOM */
        .bom-section { margin-top: 20px; }

        .bom-category {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .bom-category-title {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-200);
        }

        .bom-category-title.cat-reti { color: var(--cavatorta-green); border-color: var(--cavatorta-green); }
        .bom-category-title.cat-interno { color: var(--cavatorta-blue); border-color: var(--cavatorta-blue); }
        .bom-category-title.cat-esterno { color: var(--amber-500); border-color: var(--amber-500); }
        .bom-category-title.cat-giunzione { color: var(--purple-500); border-color: var(--purple-500); }

        .bom-table { width: 100%; font-size: 0.85rem; }
        .bom-table th { background: white; padding: 8px; text-align: left; }
        .bom-table td { padding: 8px; }
        .bom-table tr:nth-child(even) { background: white; }

        .bom-subtotal {
            text-align: right;
            font-weight: 600;
            padding-top: 8px;
            border-top: 1px solid var(--gray-300);
            margin-top: 8px;
        }

        /* Sconti e Trasporti */
        .discount-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .discount-card {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 16px;
        }

        .discount-card h4 {
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        .discount-inputs {
            display: flex;
            gap: 12px;
        }

        .discount-inputs .form-group { flex: 1; }
        .discount-inputs input { width: 100%; }

        /* Sezione Trasporti */
        .transport-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--gray-200);
        }

        .transport-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }

        .transport-type-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .transport-type-btn {
            padding: 8px 16px;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .transport-type-btn:hover {
            border-color: var(--cavatorta-green);
        }

        .transport-type-btn.active {
            border-color: var(--cavatorta-green);
            background: var(--emerald-100);
            color: var(--cavatorta-green);
            font-weight: 600;
        }

        /* Totali - NUOVA STRUTTURA TABELLARE */
        .totals-box {
            background: var(--gray-900);
            color: white;
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
        }

        .totals-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .totals-table th {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray-700);
            color: var(--gray-300);
            font-weight: 500;
        }

        .totals-table th:not(:first-child) {
            text-align: right;
        }

        .totals-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray-700);
        }

        .totals-table td:not(:first-child) {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .totals-table tr.row-reti td:first-child { color: var(--cavatorta-green); }
        .totals-table tr.row-interno td:first-child { color: var(--cavatorta-blue); }
        .totals-table tr.row-esterno td:first-child { color: var(--amber-500); }
        .totals-table tr.row-giunzione td:first-child { color: var(--purple-500); }

        .totals-table tr.row-subtotal {
            background: rgba(255,255,255,0.05);
        }

        .totals-table tr.row-subtotal td {
            font-weight: 600;
            border-top: 2px solid var(--gray-600);
        }

        .totals-table tr.row-transport td {
            color: var(--gray-400);
        }

        .totals-table tr.row-discount td {
            color: var(--red-500);
        }

        .totals-table tr.row-final {
            background: var(--cavatorta-green);
        }

        .totals-table tr.row-final td {
            font-size: 1.1rem;
            font-weight: 700;
            padding: 14px 12px;
            border: none;
        }

        .totals-table .col-sconto {
            color: var(--red-500);
        }

        /* Legenda */
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 16px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .legend-item { display: flex; align-items: flex-start; gap: 10px; font-size: 0.85rem; }
        .legend-code { font-weight: 700; min-width: 40px; color: var(--cavatorta-green); }
        .legend-desc { color: var(--gray-600); }

        .hidden { display: none !important; }

        /* Sezione Spiegazione Calcoli */
        .calc-explanation {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .calc-explanation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-200);
        }

        .calc-explanation-header .badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .calc-explanation-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--gray-800);
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .calc-box {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            padding: 12px;
        }

        .calc-box-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--gray-700);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .calc-box-title .icon {
            font-size: 1rem;
        }

        .calc-formula {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            background: var(--gray-100);
            padding: 8px 10px;
            border-radius: 4px;
            margin-bottom: 6px;
            color: var(--gray-700);
            line-height: 1.6;
        }

        .calc-result {
            font-weight: 700;
            font-size: 1rem;
            color: var(--cavatorta-green);
        }

        .calc-note {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 4px;
            font-style: italic;
        }

        select.height-select {
            background: var(--purple-100);
            border-color: var(--purple-500);
            color: var(--purple-500);
            font-weight: 600;
        }

        /* Ottimizzazione Sfridi */
        .optimization-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .optimization-info {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.875rem;
            color: var(--gray-700);
            line-height: 1.5;
        }

        .optimization-info strong {
            color: var(--cavatorta-green);
        }

        /* Riepilogo Ottimizzazione nel BOM */
        .optimization-summary {
            background: linear-gradient(135deg, var(--emerald-100) 0%, var(--gray-50) 100%);
            border: 1px solid var(--emerald-500);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .optimization-summary-title {
            font-weight: 700;
            color: var(--emerald-500);
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .optimization-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .optimization-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .optimization-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--cavatorta-green);
        }

        .optimization-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .optimization-stat.saving .optimization-stat-value {
            color: var(--emerald-500);
        }

        /* Dettaglio Rotoli */
        .roll-allocation {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }

        .roll-allocation-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .roll-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed var(--gray-200);
            font-size: 0.85rem;
        }

        .roll-item:last-child {
            border-bottom: none;
        }

        .roll-item-remnant {
            color: var(--emerald-500);
            font-weight: 600;
        }

        .roll-item-remnant.unusable {
            color: var(--amber-500);
        }

        /* Tooltip Info - VERSIONE CORRETTA */
        .info-tooltip-wrapper {
            display: inline-block;
            position: relative;
            margin-left: 4px;
            vertical-align: middle;
        }

        .info-tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--cavatorta-blue);
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
        }

        .tooltip-content {
            display: none;
            position: fixed;
            width: 360px;
            background: var(--gray-900);
            color: white;
            padding: 16px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: normal;
            text-align: left;
            z-index: 99999;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            line-height: 1.6;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .tooltip-content.show {
            display: block;
        }

        .tooltip-content strong {
            color: var(--cavatorta-green);
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .tooltip-content .tooltip-section {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-700);
        }

        .tooltip-content .tooltip-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .tooltip-close {
            position: absolute;
            top: 8px;
            right: 10px;
            background: none;
            border: none;
            color: var(--gray-400);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px 8px;
        }

        .tooltip-close:hover {
            color: white;
        }

        .tooltip-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99998;
        }

        .tooltip-overlay.show {
            display: block;
        }

        /* Nota prodotti non forniti */
        .note-non-fornito {
            background: var(--amber-100);
            border: 1px solid var(--amber-500);
            border-radius: 6px;
            padding: 10px 14px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: var(--gray-700);
        }

        .note-non-fornito strong {
            color: var(--amber-500);
        }

        /* Nota giacenze */
        .note-giacenze {
            background: var(--gray-50);
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            padding: 10px 14px;
            margin-top: 16px;
            font-size: 0.8rem;
            color: var(--gray-600);
            text-align: center;
        }

        /* Export Buttons */
        .export-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 2px solid var(--gray-200);
        }

        .export-section h3 {
            font-size: 1rem;
            color: var(--gray-700);
            margin-bottom: 16px;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-export {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export-pdf {
            background: #dc2626;
            color: white;
        }

        .btn-export-pdf:hover {
            background: #b91c1c;
        }

        .btn-export-excel {
            background: #16a34a;
            color: white;
        }

        .btn-export-excel:hover {
            background: #15803d;
        }

        .btn-export-whatsapp {
            background: #25d366;
            color: white;
        }

        .btn-export-whatsapp:hover {
            background: #1da851;
        }

        .btn-export-email {
            background: var(--cavatorta-blue);
            color: white;
        }

        .btn-export-email:hover {
            background: #1e40af;
        }

        .btn-export:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .header-content { flex-direction: column; gap: 16px; text-align: center; }
            .header-logo { flex-direction: column; }
            .header-text h1 { font-size: 1.4rem; }
            th, td { padding: 8px 4px; font-size: 0.8rem; }
            .tooltip-content { width: 260px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-logo">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="white">
                        <path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 8.82l7 3.5v7.32l-7-3.5V8.82zm9 10.82v-7.32l7-3.5v7.32l-7 3.5z"/>
                    </svg>
                    <div class="header-text">
                        <h1>COPERTEC SYSTEM</h1>
                        <span>Reti Anticaduta Certificate CNR A.T. 650/25</span>
                    </div>
                </div>
                <div class="header-badges">
                    <span class="badge-cert">ITC-CNR</span>
                    <span class="badge-version">v3.3</span>
                </div>
            </div>
            <div class="header-subtitle">
                L'unico sistema certificato con ITC-CNR membro UEATc, reti conformi ai requisiti CAM
            </div>
        </div>

        <!-- Dati Cliente -->
        <div class="section">
            <h2 class="section-title">Dati Cliente</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Ragione Sociale *</label>
                    <input type="text" id="clientName" placeholder="Nome azienda">
                </div>
                <div class="form-group">
                    <label>Referente</label>
                    <input type="text" id="clientContact" placeholder="Nome e cognome">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail" placeholder="email@azienda.it">
                </div>
                <div class="form-group">
                    <label>Telefono</label>
                    <input type="tel" id="clientPhone" placeholder="+39...">
                </div>
                <div class="form-group">
                    <label>Cantiere/Progetto</label>
                    <input type="text" id="projectName" placeholder="Nome progetto">
                </div>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="quoteDate">
                </div>
            </div>
        </div>

        <!-- Legenda Schemi -->
        <div class="section">
            <h2 class="section-title">Legenda Schemi di Posa (CNR A.T. 650/25)</h2>
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-code">A/B/C</span>
                    <span class="legend-desc">Rete singola SOTTO lucernario, 0-50cm da piano</span>
                </div>
                <div class="legend-item">
                    <span class="legend-code">A1/B1/C1</span>
                    <span class="legend-desc">Rete singola SOTTO, 50-120cm da piano</span>
                </div>
                <div class="legend-item">
                    <span class="legend-code">A2/B2/C2</span>
                    <span class="legend-desc">Reti GIUNTATE trasversalmente SOTTO lucernario</span>
                </div>
                <div class="legend-item">
                    <span class="legend-code">D</span>
                    <span class="legend-desc">Rete singola SOPRA greche PARALLELE (solo COPERPLAX)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-code">E</span>
                    <span class="legend-desc">Rete singola SOPRA greche PERPENDICOLARI (solo COPERPLAX)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-code">D2</span>
                    <span class="legend-desc">Reti GIUNTATE su greche parallele (solo COPERPLAX)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-code">E2</span>
                    <span class="legend-desc">Reti GIUNTATE su greche perpendicolari (solo COPERPLAX)</span>
                </div>
            </div>
        </div>

        <!-- Ottimizzazione Sfridi -->
        <div class="section">
            <h2 class="section-title">Ottimizzazione Sfridi</h2>
            <div class="optimization-container">
                <div class="form-group" style="max-width: 450px;">
                    <label>Modalità di calcolo rotoli</label>
                    <select id="optimizationMode" onchange="updateOptimizationInfo(); calculateBOM();">
                        <option value="standard">Standard (nessun riutilizzo avanzi)</option>
                        <option value="optimized">Massimo Risparmio (avanzi ≥5m, giunzioni minimizzate)</option>
                        <option value="balanced" selected>Equilibrata (avanzi ≥4m, max 1 giunzione) - Consigliata</option>
                    </select>
                </div>
                <div class="optimization-info" id="optimizationInfo">
                    <strong>Modalità Equilibrata (Consigliata):</strong> Riutilizza avanzi ≥4m con massimo 1 giunzione longitudinale per lucernario. Ottimo compromesso tra risparmio materiale e praticità di posa.
                </div>
            </div>
        </div>

        <!-- Configurazione Lucernari -->
        <div class="section">
            <h2 class="section-title">Configurazione Lucernari</h2>
            
            <div class="table-container">
                <table id="skylightsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Qtà</th>
                            <th>Nome</th>
                            <th>Schema</th>
                            <th>Tipo Rete</th>
                            <th>
                                Larghezza (cm)
                                <span class="info-tooltip-wrapper">
                                    <span class="info-tooltip-icon" onclick="toggleTooltip()">i</span>
                                </span>
                            </th>
                            <th>Lunghezza (m)</th>
                            <th id="thPassoGreche" class="hidden">Passo Greche</th>
                            <th id="thStruttura">Struttura</th>
                            <th id="thProfilo">Profilo</th>
                            <th>H Rete</th>
                            <th>L Tecnica</th>
                            <th>Stato</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="skylightsBody"></tbody>
                </table>
            </div>

            <div class="actions-row">
                <button class="btn btn-primary" onclick="addSkylight()">+ Aggiungi Lucernario</button>
                <button class="btn btn-secondary" onclick="clearAll()">Pulisci Tutto</button>
            </div>
        </div>

        <!-- Sconti e Trasporti -->
        <div class="section" id="discountSection">
            <h2 class="section-title">Scontistica e Trasporti</h2>
            
            <div class="discount-grid">
                <div class="discount-card">
                    <h4 style="color: var(--cavatorta-green);">Reti (Copertec/Coperplax)</h4>
                    <div class="discount-inputs">
                        <div class="form-group">
                            <label>Sconto 1 (%)</label>
                            <input type="number" id="discReti1" value="0" min="0" max="100" onchange="calculateBOMDebounced()">
                        </div>
                        <div class="form-group">
                            <label>Extra Sconto (%)</label>
                            <input type="number" id="discReti2" value="0" min="0" max="100" onchange="calculateBOMDebounced()">
                        </div>
                    </div>
                </div>
                <div class="discount-card">
                    <h4 style="color: var(--cavatorta-blue);">Accessori Interno</h4>
                    <div class="discount-inputs">
                        <div class="form-group">
                            <label>Sconto 1 (%)</label>
                            <input type="number" id="discInterno1" value="0" min="0" max="100" onchange="calculateBOMDebounced()">
                        </div>
                        <div class="form-group">
                            <label>Extra Sconto (%)</label>
                            <input type="number" id="discInterno2" value="0" min="0" max="100" onchange="calculateBOMDebounced()">
                        </div>
                    </div>
                </div>
                <div class="discount-card">
                    <h4 style="color: var(--amber-500);">Accessori Esterno</h4>
                    <div class="discount-inputs">
                        <div class="form-group">
                            <label>Sconto 1 (%)</label>
                            <input type="number" id="discEsterno1" value="0" min="0" max="100" onchange="calculateBOMDebounced()">
                        </div>
                        <div class="form-group">
                            <label>Extra Sconto (%)</label>
                            <input type="number" id="discEsterno2" value="0" min="0" max="100" onchange="calculateBOMDebounced()">
                        </div>
                    </div>
                </div>
                <div class="discount-card">
                    <h4 style="color: var(--purple-500);">Accessori Giunzione</h4>
                    <div class="discount-inputs">
                        <div class="form-group">
                            <label>Sconto 1 (%)</label>
                            <input type="number" id="discGiunzione1" value="0" min="0" max="100" onchange="calculateBOMDebounced()">
                        </div>
                        <div class="form-group">
                            <label>Extra Sconto (%)</label>
                            <input type="number" id="discGiunzione2" value="0" min="0" max="100" onchange="calculateBOMDebounced()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sezione Trasporti -->
            <div class="transport-section">
                <h4 style="margin-bottom: 16px; color: var(--gray-700);">Incidenza Trasporti</h4>
                <div class="transport-grid">
                    <div class="form-group">
                        <label>Modalità di consegna</label>
                        <div class="transport-type-selector">
                            <button type="button" class="transport-type-btn active" onclick="setTransportType('partenza')">Franco Partenza</button>
                            <button type="button" class="transport-type-btn" onclick="setTransportType('destino')">Franco Destino</button>
                        </div>
                    </div>
                    <div class="form-group" id="transportValueGroup" style="display: none;">
                        <label>Tipo di addebito</label>
                        <select id="transportCalcType" onchange="toggleTransportInput()">
                            <option value="fisso">Importo fisso (€)</option>
                            <option value="percentuale">Percentuale sul totale (%)</option>
                        </select>
                    </div>
                    <div class="form-group" id="transportInputGroup" style="display: none;">
                        <label id="transportInputLabel">Importo (€)</label>
                        <input type="number" id="transportValue" value="0" min="0" step="0.01" onchange="calculateBOMDebounced()">
                    </div>
                </div>
                <input type="hidden" id="transportType" value="partenza">
            </div>
        </div>

        <!-- SEZIONE SPIEGAZIONE CALCOLI -->
        <div class="section" id="calculationsSection" style="display: none;">
            <details class="collapsible-section" open>
                <summary>Dettaglio Calcoli</summary>
                <div class="details-content" id="calculationsContent"></div>
            </details>
        </div>

        <!-- BOM -->
        <div class="section" id="bomSection" style="display: none;">
            <h2 class="section-title">Distinta Materiali (BOM)</h2>
            <div id="bomContent"></div>

            <!-- Totali - NUOVA STRUTTURA TABELLARE -->
            <div class="totals-box" id="totalsBox">
                <table class="totals-table">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Listino</th>
                            <th>Sconto %</th>
                            <th>Scontato</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="row-reti">
                            <td>Reti</td>
                            <td id="listinoReti">€ 0,00</td>
                            <td id="scontoRetiPerc" class="col-sconto">0%</td>
                            <td id="scontatoReti">€ 0,00</td>
                        </tr>
                        <tr class="row-interno">
                            <td>Accessori Interno</td>
                            <td id="listinoInterno">€ 0,00</td>
                            <td id="scontoInternoPerc" class="col-sconto">0%</td>
                            <td id="scontatoInterno">€ 0,00</td>
                        </tr>
                        <tr class="row-esterno">
                            <td>Accessori Esterno</td>
                            <td id="listinoEsterno">€ 0,00</td>
                            <td id="scontoEsternoPerc" class="col-sconto">0%</td>
                            <td id="scontatoEsterno">€ 0,00</td>
                        </tr>
                        <tr class="row-giunzione">
                            <td>Accessori Giunzione</td>
                            <td id="listinoGiunzione">€ 0,00</td>
                            <td id="scontoGiunzionePerc" class="col-sconto">0%</td>
                            <td id="scontatoGiunzione">€ 0,00</td>
                        </tr>
                        <tr class="row-subtotal">
                            <td><strong>Subtotale Materiali</strong></td>
                            <td id="subtotaleListino"><strong>€ 0,00</strong></td>
                            <td></td>
                            <td id="subtotaleScontato"><strong>€ 0,00</strong></td>
                        </tr>
                        <tr class="row-transport" id="rowTransport" style="display: none;">
                            <td>Trasporto</td>
                            <td id="trasportoListino">€ 0,00</td>
                            <td>-</td>
                            <td id="trasportoScontato">€ 0,00</td>
                        </tr>
                        <tr class="row-final">
                            <td><strong>TOTALE FINALE</strong></td>
                            <td id="totaleListinoFinale"></td>
                            <td id="scontoTotalePerc"></td>
                            <td id="totaleScontatoFinale"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Sezione Export -->
            <div class="export-section">
                <h3>Esporta Preventivo</h3>
                <div class="export-buttons">
                    <button class="btn-export btn-export-pdf" onclick="exportPDF()">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/><path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.712 5.712 0 0 1-.911-.95 11.651 11.651 0 0 0-1.997.406 11.307 11.307 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.793.793 0 0 1-.58.029z"/></svg>
                        Scarica PDF
                    </button>
                    <button class="btn-export btn-export-excel" onclick="exportExcel()">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/><path d="M4.879 11.243l1.377-4.486h1.016l1.377 4.486h-.977l-.252-.906H6.108l-.253.906h-.976zm1.425-1.566h1.117l-.56-2.02-.557 2.02z"/></svg>
                        Scarica Excel
                    </button>
                    <button class="btn-export btn-export-whatsapp" onclick="exportWhatsApp()">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                        Invia WhatsApp
                    </button>
                    <button class="btn-export btn-export-email" onclick="exportEmail()">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/></svg>
                        Invia Email
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; padding: 20px; color: var(--gray-500); font-size: 0.85rem;">
            Cavatorta SpA - Sistema conforme CNR A.T. 650/25 | Configuratore v3.1
        </div>
    </div>

    <!-- Tooltip Modal -->
    <div class="tooltip-overlay" id="tooltipOverlay" onclick="toggleTooltip()"></div>
    <div class="tooltip-content" id="tooltipContent">
        <button class="tooltip-close" onclick="toggleTooltip()">&times;</button>
        <div class="tooltip-section">
            <strong>Schemi A, B, C, A1, B1, C1, A2, B2, C2 (Interni):</strong>
            Inserire la <u>Luce netta</u> = distanza libera tra gli elementi strutturali portanti del lucernario (travi, cordoli, profili metallici).
        </div>
        <div class="tooltip-section">
            <strong>Schemi D, D2 (Esterni - greche parallele):</strong>
            Inserire la <u>Misura X</u> = luce netta asse greche di fissaggio, escluse greche non complete o con sovrapposizione di lastre non calpestabili.
        </div>
        <div class="tooltip-section">
            <strong>Schemi E, E2 (Esterni - greche perpendicolari):</strong>
            Inserire la <u>Misura Y</u> = luce netta del vano da coprire, esclusi eventuali sormonti di lastre non calpestabili.
        </div>
    </div>

    <script>
    // ================================================================
    // DATABASE PRODOTTI
    // ================================================================

    const PRODUCTS = {
        // RETI COPERTEC (Zincata)
        'SZAC102025B': { code: 'SZAC102025B', desc: 'Rete COPERTEC H.102cm (25m)', price: 114.57, category: 'reti', height: 102 },
        'SZAC122025B': { code: 'SZAC122025B', desc: 'Rete COPERTEC H.122cm (25m)', price: 137.09, category: 'reti', height: 122 },
        'SZAC152025B': { code: 'SZAC152025B', desc: 'Rete COPERTEC H.152cm (25m)', price: 164.11, category: 'reti', height: 152 },
        'SZAC183025B': { code: 'SZAC183025B', desc: 'Rete COPERTEC H.183cm (25m)', price: 197.13, category: 'reti', height: 183 },
        'SZAC203025B': { code: 'SZAC203025B', desc: 'Rete COPERTEC H.203cm (25m)', price: 218.90, category: 'reti', height: 203 },
        'SZAC223025B': { code: 'SZAC223025B', desc: 'Rete COPERTEC H.223cm (25m)', price: 254.42, category: 'reti', height: 223 },
        'SZAC253025B': { code: 'SZAC253025B', desc: 'Rete COPERTEC H.253cm (25m)', price: 287.44, category: 'reti', height: 253 },
        
        // RETI COPERPLAX (Plastificata)
        'SEAC1020258': { code: 'SEAC1020258', desc: 'Rete COPERPLAX H.102cm (25m)', price: 137.48, category: 'reti', height: 102 },
        'SEAC1220258': { code: 'SEAC1220258', desc: 'Rete COPERPLAX H.122cm (25m)', price: 164.51, category: 'reti', height: 122 },
        'SEAC1520258': { code: 'SEAC1520258', desc: 'Rete COPERPLAX H.152cm (25m)', price: 205.63, category: 'reti', height: 152 },
        'SEAC1830258': { code: 'SEAC1830258', desc: 'Rete COPERPLAX H.183cm (25m)', price: 246.76, category: 'reti', height: 183 },
        'SEAC2030258': { code: 'SEAC2030258', desc: 'Rete COPERPLAX H.203cm (25m)', price: 274.18, category: 'reti', height: 203 },
        'SEAC2230258': { code: 'SEAC2230258', desc: 'Rete COPERPLAX H.223cm (25m)', price: 301.19, category: 'reti', height: 223 },
        'SEAC2440258': { code: 'SEAC2440258', desc: 'Rete COPERPLAX H.244cm (25m)', price: 339.07, category: 'reti', height: 244 },

        // VITI ACCESSORI INTERNO
        'VQAS70050B': { code: 'VQAS70050B', desc: 'Vite CLS 8.0x50mm', price: 62.52, pcs: 100, category: 'interno' },
        'VQAS70060B': { code: 'VQAS70060B', desc: 'Vite CLS 8.0x65mm', price: 68.13, pcs: 100, category: 'interno' },
        'VQAS70100B': { code: 'VQAS70100B', desc: 'Vite CLS 8.0x100mm', price: 46.80, pcs: 50, category: 'interno' },
        'VQAS70035B': { code: 'VQAS70035B', desc: 'Vite TER 6.3x35mm', price: 38.77, pcs: 200, category: 'interno' },
        'VQAS70085B': { code: 'VQAS70085B', desc: 'Vite SBS 6.3x85mm', price: 21.23, pcs: 100, category: 'interno' },
        'VQAS70090B': { code: 'VQAS70090B', desc: 'Vite HBS EVO 6x90mm', price: 30.64, pcs: 100, category: 'interno' },
        'VQAS70120B': { code: 'VQAS70120B', desc: 'Vite HBS 6x120mm', price: 19.02, pcs: 100, category: 'interno' },
        'VQAS60025B': { code: 'VQAS60025B', desc: 'Nastro Forato 39x1.95mm (25m)', price: 63.23, pcs: 1, category: 'interno', isRoll: true, rollLength: 25 },

        // ACCESSORI ESTERNO
        'VQAS01142B': { code: 'VQAS01142B', desc: 'Piastra Inox 1.5mm 142x19mm', price: 99.34, pcs: 100, category: 'esterno' },
        'VQAS20142B': { code: 'VQAS20142B', desc: 'Guarnizione EPDM 142x19x4mm', price: 41.60, pcs: 100, category: 'esterno' },
        'VQAS50100B': { code: 'VQAS50100B', desc: 'Rivetto 7.7x28mm', price: 285.00, pcs: 300, category: 'esterno' },

        // ACCESSORI GIUNZIONE
        'VQAS55450B': { code: 'VQAS55450B', desc: 'Molle Galvatec', price: 50.25, pcs: 450, category: 'giunzione' },
        'VQ2430B': { code: 'VQ2430B', desc: 'Punti 20mm (Graffe)', price: 23.91, pcs: 1000, category: 'giunzione' },
    };

    // Matrice Viti: [Struttura][Profilo] => codice vite
    const SCREW_MATRIX = {
        'cls': {
            'nastro': 'VQAS70050B',
            'piatto': 'VQAS70050B',
            'profiloL': 'VQAS70050B',
            'legno': 'VQAS70100B'
        },
        'acciaio': {
            'nastro': 'VQAS70035B',
            'piatto': 'VQAS70035B',
            'profiloL': 'VQAS70035B',
            'legno': 'VQAS70085B'
        },
        'legno': {
            'nastro': 'VQAS70090B',
            'piatto': 'VQAS70090B',
            'profiloL': 'VQAS70090B',
            'legno': 'VQAS70120B'
        }
    };

    // ================================================================
    // LOOKUP TABLES CNR
    // ================================================================

    const LOOKUP_ABC = [
        { schema: 'A', net_type: 'both', height: 102, luce_min: 0, luce_max: 77, spacing: 100 },
        { schema: 'B', net_type: 'both', height: 102, luce_min: 0, luce_max: 84, spacing: 100 },
        { schema: 'C', net_type: 'both', height: 102, luce_min: 0, luce_max: 77, spacing: 100 },
        { schema: 'A', net_type: 'both', height: 122, luce_min: 73, luce_max: 97, spacing: 90 },
        { schema: 'B', net_type: 'both', height: 122, luce_min: 82, luce_max: 104, spacing: 90 },
        { schema: 'C', net_type: 'both', height: 122, luce_min: 73, luce_max: 97, spacing: 90 },
        { schema: 'A', net_type: 'both', height: 152, luce_min: 93, luce_max: 127, spacing: 70 },
        { schema: 'B', net_type: 'both', height: 152, luce_min: 102, luce_max: 134, spacing: 70 },
        { schema: 'C', net_type: 'both', height: 152, luce_min: 93, luce_max: 127, spacing: 70 },
        { schema: 'A', net_type: 'both', height: 183, luce_min: 123, luce_max: 158, spacing: 60 },
        { schema: 'B', net_type: 'both', height: 183, luce_min: 132, luce_max: 165, spacing: 60 },
        { schema: 'C', net_type: 'both', height: 183, luce_min: 123, luce_max: 158, spacing: 60 },
        { schema: 'A', net_type: 'both', height: 203, luce_min: 153, luce_max: 178, spacing: 50 },
        { schema: 'B', net_type: 'both', height: 203, luce_min: 163, luce_max: 185, spacing: 50 },
        { schema: 'C', net_type: 'both', height: 203, luce_min: 153, luce_max: 178, spacing: 50 },
        { schema: 'A', net_type: 'copertec', height: 223, luce_min: 173, luce_max: 198, spacing: 40 },
        { schema: 'B', net_type: 'copertec', height: 223, luce_min: 183, luce_max: 205, spacing: 40 },
        { schema: 'C', net_type: 'copertec', height: 223, luce_min: 173, luce_max: 198, spacing: 40 },
        { schema: 'A', net_type: 'coperplax', height: 244, luce_min: 183, luce_max: 218, spacing: 30 },
        { schema: 'B', net_type: 'coperplax', height: 244, luce_min: 193, luce_max: 225, spacing: 30 },
        { schema: 'C', net_type: 'coperplax', height: 244, luce_min: 183, luce_max: 218, spacing: 30 },
        { schema: 'A', net_type: 'copertec', height: 253, luce_min: 193, luce_max: 228, spacing: 30 },
        { schema: 'B', net_type: 'copertec', height: 253, luce_min: 203, luce_max: 235, spacing: 30 },
        { schema: 'C', net_type: 'copertec', height: 253, luce_min: 193, luce_max: 228, spacing: 30 },
    ];

    const LOOKUP_A1B1C1 = [
        { schema: 'A1', net_type: 'both', height: 102, luce_min: 0, luce_max: 77, spacing: 25.4 },
        { schema: 'B1', net_type: 'both', height: 102, luce_min: 0, luce_max: 84, spacing: 25.4 },
        { schema: 'C1', net_type: 'both', height: 102, luce_min: 0, luce_max: 77, spacing: 25.4 },
        { schema: 'A1', net_type: 'both', height: 122, luce_min: 73, luce_max: 97, spacing: 25.4 },
        { schema: 'B1', net_type: 'both', height: 122, luce_min: 82, luce_max: 104, spacing: 25.4 },
        { schema: 'C1', net_type: 'both', height: 122, luce_min: 73, luce_max: 97, spacing: 25.4 },
        { schema: 'A1', net_type: 'both', height: 152, luce_min: 93, luce_max: 123, spacing: 25.4 },
        { schema: 'B1', net_type: 'both', height: 152, luce_min: 102, luce_max: 134, spacing: 25.4 },
        { schema: 'C1', net_type: 'both', height: 152, luce_min: 93, luce_max: 123, spacing: 25.4 },
        { schema: 'A1', net_type: 'both', height: 183, luce_min: 119, luce_max: 158, spacing: 25.4 },
        { schema: 'B1', net_type: 'both', height: 183, luce_min: 132, luce_max: 165, spacing: 25.4 },
        { schema: 'C1', net_type: 'both', height: 183, luce_min: 119, luce_max: 158, spacing: 25.4 },
        { schema: 'A1', net_type: 'both', height: 203, luce_min: 153, luce_max: 178, spacing: 25.4 },
        { schema: 'B1', net_type: 'both', height: 203, luce_min: 163, luce_max: 185, spacing: 25.4 },
        { schema: 'C1', net_type: 'both', height: 203, luce_min: 153, luce_max: 178, spacing: 25.4 },
        { schema: 'A1', net_type: 'copertec', height: 223, luce_min: 173, luce_max: 198, spacing: 25.4 },
        { schema: 'B1', net_type: 'copertec', height: 223, luce_min: 183, luce_max: 205, spacing: 25.4 },
        { schema: 'C1', net_type: 'copertec', height: 223, luce_min: 173, luce_max: 198, spacing: 25.4 },
        { schema: 'A1', net_type: 'coperplax', height: 244, luce_min: 193, luce_max: 218, spacing: 25.4 },
        { schema: 'B1', net_type: 'coperplax', height: 244, luce_min: 203, luce_max: 225, spacing: 25.4 },
        { schema: 'C1', net_type: 'coperplax', height: 244, luce_min: 193, luce_max: 218, spacing: 25.4 },
        { schema: 'A1', net_type: 'copertec', height: 253, luce_min: 193, luce_max: 228, spacing: 25.4 },
        { schema: 'B1', net_type: 'copertec', height: 253, luce_min: 223, luce_max: 235, spacing: 25.4 },
        { schema: 'C1', net_type: 'copertec', height: 253, luce_min: 193, luce_max: 228, spacing: 25.4 },
    ];

    const LOOKUP_A2B2C2 = [
        { schema: 'A2', net_type: 'both', height: 102, luce_min: 152, luce_max: 167, spacing: 25.4 },
        { schema: 'B2', net_type: 'both', height: 102, luce_min: 157, luce_max: 172, spacing: 25.4 },
        { schema: 'C2', net_type: 'both', height: 102, luce_min: 152, luce_max: 167, spacing: 25.4 },
        { schema: 'A2', net_type: 'both', height: 122, luce_min: 167, luce_max: 208, spacing: 25.4 },
        { schema: 'B2', net_type: 'both', height: 122, luce_min: 172, luce_max: 212, spacing: 25.4 },
        { schema: 'C2', net_type: 'both', height: 122, luce_min: 167, luce_max: 208, spacing: 25.4 },
        { schema: 'A2', net_type: 'both', height: 152, luce_min: 208, luce_max: 269, spacing: 25.4 },
        { schema: 'B2', net_type: 'both', height: 152, luce_min: 212, luce_max: 272, spacing: 25.4 },
        { schema: 'C2', net_type: 'both', height: 152, luce_min: 208, luce_max: 269, spacing: 25.4 },
        { schema: 'A2', net_type: 'both', height: 183, luce_min: 266, luce_max: 330, spacing: 25.4 },
        { schema: 'B2', net_type: 'both', height: 183, luce_min: 272, luce_max: 334, spacing: 25.4 },
        { schema: 'C2', net_type: 'both', height: 183, luce_min: 266, luce_max: 330, spacing: 25.4 },
        { schema: 'A2', net_type: 'both', height: 203, luce_min: 330, luce_max: 369, spacing: 25.4 },
        { schema: 'B2', net_type: 'both', height: 203, luce_min: 334, luce_max: 374, spacing: 25.4 },
        { schema: 'C2', net_type: 'both', height: 203, luce_min: 330, luce_max: 369, spacing: 25.4 },
        { schema: 'A2', net_type: 'copertec', height: 223, luce_min: 369, luce_max: 409, spacing: 25.4 },
        { schema: 'B2', net_type: 'copertec', height: 223, luce_min: 374, luce_max: 414, spacing: 25.4 },
        { schema: 'C2', net_type: 'copertec', height: 223, luce_min: 369, luce_max: 409, spacing: 25.4 },
        { schema: 'A2', net_type: 'coperplax', height: 244, luce_min: 409, luce_max: 450, spacing: 25.4 },
        { schema: 'B2', net_type: 'coperplax', height: 244, luce_min: 414, luce_max: 456, spacing: 25.4 },
        { schema: 'C2', net_type: 'coperplax', height: 244, luce_min: 409, luce_max: 450, spacing: 25.4 },
        { schema: 'A2', net_type: 'copertec', height: 253, luce_min: 450, luce_max: 470, spacing: 25.4 },
        { schema: 'B2', net_type: 'copertec', height: 253, luce_min: 456, luce_max: 474, spacing: 25.4 },
        { schema: 'C2', net_type: 'copertec', height: 253, luce_min: 450, luce_max: 470, spacing: 25.4 },
    ];

    const LOOKUP_D = [
        { schema: 'D', net_type: 'coperplax', height: 102, luce_min: 0, luce_max: 88, plate_spacing: 50 },
        { schema: 'D', net_type: 'coperplax', height: 122, luce_min: 89, luce_max: 107, plate_spacing: 50 },
        { schema: 'D', net_type: 'coperplax', height: 152, luce_min: 108, luce_max: 139, plate_spacing: 50 },
        { schema: 'D', net_type: 'coperplax', height: 183, luce_min: 140, luce_max: 169, plate_spacing: 50 },
        { schema: 'D', net_type: 'coperplax', height: 203, luce_min: 170, luce_max: 188, plate_spacing: 50 },
        { schema: 'D', net_type: 'coperplax', height: 223, luce_min: 189, luce_max: 208, plate_spacing: 50 },
        { schema: 'D', net_type: 'coperplax', height: 244, luce_min: 209, luce_max: 230, plate_spacing: 50 },
    ];

    const LOOKUP_E = [
        { schema: 'E', net_type: 'coperplax', height: 102, luce_min: 0, luce_max: 69, plate_spacing: 55 },
        { schema: 'E', net_type: 'coperplax', height: 122, luce_min: 70, luce_max: 89, plate_spacing: 55 },
        { schema: 'E', net_type: 'coperplax', height: 152, luce_min: 90, luce_max: 120, plate_spacing: 55 },
        { schema: 'E', net_type: 'coperplax', height: 183, luce_min: 121, luce_max: 150, plate_spacing: 55 },
        { schema: 'E', net_type: 'coperplax', height: 203, luce_min: 151, luce_max: 170, plate_spacing: 55 },
        { schema: 'E', net_type: 'coperplax', height: 223, luce_min: 171, luce_max: 191, plate_spacing: 55 },
        { schema: 'E', net_type: 'coperplax', height: 244, luce_min: 192, luce_max: 211, plate_spacing: 55 },
    ];

    const LOOKUP_D2 = [
        { schema: 'D2', net_type: 'coperplax', height: 102, luce_min: 160, luce_max: 178, plate_spacing: 50 },
        { schema: 'D2', net_type: 'coperplax', height: 122, luce_min: 179, luce_max: 219, plate_spacing: 50 },
        { schema: 'D2', net_type: 'coperplax', height: 152, luce_min: 220, luce_max: 280, plate_spacing: 50 },
        { schema: 'D2', net_type: 'coperplax', height: 183, luce_min: 281, luce_max: 341, plate_spacing: 50 },
        { schema: 'D2', net_type: 'coperplax', height: 203, luce_min: 342, luce_max: 381, plate_spacing: 50 },
        { schema: 'D2', net_type: 'coperplax', height: 223, luce_min: 382, luce_max: 422, plate_spacing: 50 },
        { schema: 'D2', net_type: 'coperplax', height: 244, luce_min: 423, luce_max: 463, plate_spacing: 50 },
    ];

    const LOOKUP_E2 = [
        { schema: 'E2', net_type: 'coperplax', height: 102, luce_min: 0, luce_max: 161, plate_spacing: 55 },
        { schema: 'E2', net_type: 'coperplax', height: 122, luce_min: 162, luce_max: 201, plate_spacing: 55 },
        { schema: 'E2', net_type: 'coperplax', height: 152, luce_min: 202, luce_max: 262, plate_spacing: 55 },
        { schema: 'E2', net_type: 'coperplax', height: 183, luce_min: 263, luce_max: 323, plate_spacing: 55 },
        { schema: 'E2', net_type: 'coperplax', height: 203, luce_min: 324, luce_max: 363, plate_spacing: 55 },
        { schema: 'E2', net_type: 'coperplax', height: 223, luce_min: 364, luce_max: 404, plate_spacing: 55 },
        { schema: 'E2', net_type: 'coperplax', height: 244, luce_min: 405, luce_max: 445, plate_spacing: 55 },
    ];

    // ================================================================
    // COSTANTI
    // ================================================================

    const ROLL_LENGTH_M = 25;
    const MAGLIA_MM = 50.8;
    const SPONDE_ABC = 3 * 0.0508 * 2;
    const SPONDE_A1B1C1 = 10 * 0.0254 * 2;
    const SPONDE_A2B2C2 = 10 * 0.0508 * 2;
    const SPONDE_D2E2 = 4 * 0.0508 * 2;
    const MAX_PLATE_SPACING_E = 55;
    const OVERLAP_SMALL = 0.5;
    const OVERLAP_LARGE = 1.0;


    // Debounce per evitare calcoli multipli simultanei
    let bomCalculationTimeout = null;
    function calculateBOMDebounced() {
        if (bomCalculationTimeout) {
            clearTimeout(bomCalculationTimeout);
        }
        bomCalculationTimeout = setTimeout(() => {
            calculateBOM();
        }, 300);
    }
    // ================================================================
    // STATO APPLICAZIONE
    // ================================================================

    let skylights = [];
    let skylightCounter = 0;
    let bom = {};

    // ================================================================
    // FUNZIONI UTILITY
    // ================================================================

    function formatCurrency(value) {
        return '€ ' + value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function getLookupTable(schema) {
        if (['A', 'B', 'C'].includes(schema)) return LOOKUP_ABC;
        if (['A1', 'B1', 'C1'].includes(schema)) return LOOKUP_A1B1C1;
        if (['A2', 'B2', 'C2'].includes(schema)) return LOOKUP_A2B2C2;
        if (schema === 'D') return LOOKUP_D;
        if (schema === 'E') return LOOKUP_E;
        if (schema === 'D2') return LOOKUP_D2;
        if (schema === 'E2') return LOOKUP_E2;
        return null;
    }

    function findNetHeightOptions(schema, luce, netType) {
        const table = getLookupTable(schema);
        if (!table) return { error: 'Schema non valido' };

        const candidates = table.filter(row => {
            if (row.schema !== schema) return false;
            if (row.net_type === 'both') return true;
            return row.net_type === netType;
        });

        const matches = [];
        for (const row of candidates) {
            if (luce >= row.luce_min && luce <= row.luce_max) {
                matches.push({
                    height: row.height,
                    spacing: row.spacing || row.plate_spacing,
                    row: row
                });
            }
        }

        if (matches.length === 0) {
            const minLuce = Math.min(...candidates.map(r => r.luce_min));
            const maxLuce = Math.max(...candidates.map(r => r.luce_max));
            return { error: `Fuori range (${minLuce}-${maxLuce}cm)` };
        }

        matches.sort((a, b) => a.height - b.height);
        return { options: matches, hasMultiple: matches.length > 1 };
    }

    function isExternalSchema(schema) { return ['D', 'E', 'D2', 'E2'].includes(schema); }
    function isJointedSchema(schema) { return ['A2', 'B2', 'C2', 'D2', 'E2'].includes(schema); }
    function isInternalSchema(schema) { return ['A', 'B', 'C', 'A1', 'B1', 'C1', 'A2', 'B2', 'C2'].includes(schema); }
    function needsPassoGreche(schema) { return ['E', 'E2'].includes(schema); }

    function calculatePlateSpacing(schema, passoGreche) {
        if (!needsPassoGreche(schema)) return null;
        if (!passoGreche || passoGreche <= 0) return MAX_PLATE_SPACING_E;
        const multiplier = Math.floor(MAX_PLATE_SPACING_E / passoGreche);
        return multiplier < 1 ? passoGreche : multiplier * passoGreche;
    }

    function calculateLTecnica(schema, lunghezzaVanoM) {
        const validSchemas = ['A','B','C','A1','B1','C1','A2','B2','C2','D','E','D2','E2'];

        if (!validSchemas.includes(schema)) {
            console.error(`Schema non valido: "${schema}". Schemi supportati: ${validSchemas.join(', ')}`);
            return lunghezzaVanoM; // Ritorna senza sponde se schema invalido
        }

        let sponde = 0;
        if (['A', 'B', 'C'].includes(schema)) sponde = SPONDE_ABC;
        else if (['A1', 'B1', 'C1'].includes(schema)) sponde = SPONDE_A1B1C1;
        else if (['A2', 'B2', 'C2'].includes(schema)) sponde = SPONDE_A2B2C2;
        else if (['D2', 'E2'].includes(schema)) sponde = SPONDE_D2E2;
        // D ed E hanno sponde = 0 (corretto per schemi esterni singoli)

        return lunghezzaVanoM + sponde;
    }

    function getOverlap(height) {
        return height >= 203 ? OVERLAP_LARGE : OVERLAP_SMALL;
    }

    function calculateRolls(lTecnica, height) {
        const overlap = getOverlap(height);
        const effectiveRoll = ROLL_LENGTH_M - overlap;
        
        if (lTecnica <= ROLL_LENGTH_M) {
            return { rolls: 1, junctions: 0 };
        }
        
        let remaining = lTecnica - ROLL_LENGTH_M;
        let additionalRolls = Math.ceil(remaining / effectiveRoll);
        
        return {
            rolls: 1 + additionalRolls,
            junctions: additionalRolls
        };
    }

    function getNetCode(netType, height) {
        if (netType === 'copertec') {
            return `SZAC${height}025B`;
        } else {
            const heightStr = height.toString().padStart(3, '0');
            return `SEAC${heightStr}0258`;
        }
    }

    // ================================================================
    // GESTIONE TRASPORTI
    // ================================================================

    function setTransportType(type) {
        document.getElementById('transportType').value = type;
        
        document.querySelectorAll('.transport-type-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        const showInputs = (type === 'destino');
        document.getElementById('transportValueGroup').style.display = showInputs ? 'block' : 'none';
        document.getElementById('transportInputGroup').style.display = showInputs ? 'block' : 'none';

        if (!showInputs) {
            document.getElementById('transportValue').value = 0;
        }

        calculateBOM();
    }

    function toggleTransportInput() {
        const calcType = document.getElementById('transportCalcType').value;
        const label = document.getElementById('transportInputLabel');
        
        if (calcType === 'fisso') {
            label.textContent = 'Importo (€)';
        } else {
            label.textContent = 'Percentuale (%)';
        }
        
        calculateBOM();
    }

    // ================================================================
    // GESTIONE UI
    // ================================================================

    function initDate() {
        document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];
    }

    function addSkylight() {
        skylightCounter++;
        skylights.push({
            id: skylightCounter,
            qty: 1,
            name: `Lucernario ${skylightCounter}`,
            schema: 'A',
            netType: 'copertec',
            luce: 0,
            lunghezza: 0,
            passoGreche: 0,
            struttura: 'cls',
            profilo: 'nastro',
            hRete: null,
            hReteOptions: null,
            selectedHeightIndex: 0,
            lTecnica: null,
            spacing: null,
            error: null
        });
        renderTable();
    }

    function removeSkylight(id) {
        skylights = skylights.filter(s => s.id !== id);
        renderTable();
        calculateBOM();
    }

    function clearAll() {
        // Chiede conferma
        if (!window.confirm('Eliminare tutti i lucernari configurati?')) {
            return;
        }
        skylights = [];
        skylightCounter = 0;
        renderTable();
        // Nascondi sezioni
        document.getElementById('bomSection').style.display = 'none';
        document.getElementById('calculationsSection').style.display = 'none';
    }

    function renderTable() {
        const tbody = document.getElementById('skylightsBody');
        
        if (skylights.length === 0) {
            tbody.innerHTML = `<tr><td colspan="14" style="text-align:center;padding:40px;color:var(--gray-500);">
                Nessun lucernario. Clicca "Aggiungi Lucernario" per iniziare.</td></tr>`;
            document.getElementById('bomSection').style.display = 'none';
            return;
        }

        const showPasso = skylights.some(s => needsPassoGreche(s.schema));
        const showStruttura = skylights.some(s => isInternalSchema(s.schema));
        
        document.getElementById('thPassoGreche').classList.toggle('hidden', !showPasso);
        document.getElementById('thStruttura').classList.toggle('hidden', !showStruttura);
        document.getElementById('thProfilo').classList.toggle('hidden', !showStruttura);

        tbody.innerHTML = skylights.map((s, i) => {
            const isExt = isExternalSchema(s.schema);
            const needsPasso = needsPassoGreche(s.schema);
            const isInt = isInternalSchema(s.schema);
            const hasMultiple = s.hReteOptions && s.hReteOptions.length > 1;

            let hReteHtml = '-';
            if (hasMultiple) {
                hReteHtml = `<select class="height-select" onchange="selectHeight(${s.id}, this.value)">
                    ${s.hReteOptions.map((o, idx) => `<option value="${idx}" ${idx === s.selectedHeightIndex ? 'selected' : ''}>H.${o.height}</option>`).join('')}
                </select>`;
            } else if (s.hRete) {
                hReteHtml = `<span style="font-weight:600;color:var(--cavatorta-green);">${s.hRete}</span>`;
            }

            return `
                <tr>
                    <td>${i + 1}</td>
                    <td><input type="number" class="input-qty" min="1" value="${s.qty || 1}" placeholder="1" onchange="updateSkylight(${s.id},'qty',this.value)"></td>
                    <td><input type="text" class="input-name" value="${s.name}" onchange="updateSkylight(${s.id},'name',this.value)"></td>
                    <td>
                        <select onchange="updateSkylight(${s.id},'schema',this.value)">
                            <optgroup label="Interno (0-50cm)">
                                <option value="A" ${s.schema==='A'?'selected':''}>A</option>
                                <option value="B" ${s.schema==='B'?'selected':''}>B</option>
                                <option value="C" ${s.schema==='C'?'selected':''}>C</option>
                            </optgroup>
                            <optgroup label="Interno (50-120cm)">
                                <option value="A1" ${s.schema==='A1'?'selected':''}>A1</option>
                                <option value="B1" ${s.schema==='B1'?'selected':''}>B1</option>
                                <option value="C1" ${s.schema==='C1'?'selected':''}>C1</option>
                            </optgroup>
                            <optgroup label="Giuntate Interno">
                                <option value="A2" ${s.schema==='A2'?'selected':''}>A2</option>
                                <option value="B2" ${s.schema==='B2'?'selected':''}>B2</option>
                                <option value="C2" ${s.schema==='C2'?'selected':''}>C2</option>
                            </optgroup>
                            <optgroup label="Esterno (COPERPLAX)">
                                <option value="D" ${s.schema==='D'?'selected':''}>D</option>
                                <option value="E" ${s.schema==='E'?'selected':''}>E</option>
                                <option value="D2" ${s.schema==='D2'?'selected':''}>D2</option>
                                <option value="E2" ${s.schema==='E2'?'selected':''}>E2</option>
                            </optgroup>
                        </select>
                    </td>
                    <td>${isExt ? '<span class="badge-coperplax">COPERPLAX</span>' : `
                        <select onchange="updateSkylight(${s.id},'netType',this.value)">
                            <option value="copertec" ${s.netType==='copertec'?'selected':''}>COPERTEC</option>
                            <option value="coperplax" ${s.netType==='coperplax'?'selected':''}>COPERPLAX</option>
                        </select>`}
                    </td>
                    <td><input type="number" class="input-wide" min="0" value="${s.luce||''}" placeholder="cm" onchange="updateSkylight(${s.id},'luce',this.value)"></td>
                    <td><input type="number" class="input-wide" min="0" step="0.1" value="${s.lunghezza||''}" placeholder="m" onchange="updateSkylight(${s.id},'lunghezza',this.value)"></td>
                    <td class="${showPasso?'':'hidden'}">${needsPasso ? `<input type="number" min="0" value="${s.passoGreche||''}" placeholder="cm" onchange="updateSkylight(${s.id},'passoGreche',this.value)">` : '-'}</td>
                    <td class="${showStruttura?'':'hidden'}">${isInt ? `
                        <select onchange="updateSkylight(${s.id},'struttura',this.value)">
                            <option value="cls" ${s.struttura==='cls'?'selected':''}>C.A./Cls</option>
                            <option value="acciaio" ${s.struttura==='acciaio'?'selected':''}>Acciaio</option>
                            <option value="legno" ${s.struttura==='legno'?'selected':''}>Legno</option>
                        </select>` : '-'}
                    </td>
                    <td class="${showStruttura?'':'hidden'}">${isInt ? `
                        <select onchange="updateSkylight(${s.id},'profilo',this.value)">
                            <option value="nastro" ${s.profilo==='nastro'?'selected':''}>Nastro forato</option>
                            <option value="piatto" ${s.profilo==='piatto'?'selected':''}>Piatto 30x3</option>
                            <option value="profiloL" ${s.profilo==='profiloL'?'selected':''}>Profilo L 30x30x2</option>
                            <option value="legno" ${s.profilo==='legno'?'selected':''}>Listello legno</option>
                        </select>` : '-'}
                    </td>
                    <td>${hReteHtml}</td>
                    <td>${s.lTecnica ? `<span style="font-weight:600;">${s.lTecnica.toFixed(3)}</span>` : '-'}</td>
                    <td>${s.error ? `<span class="status-error">${s.error}</span>` : 
                        (!s.luce || !s.lunghezza) ? '<span class="status-warning">...</span>' :
                        hasMultiple ? '<span class="status-choice">Scelta</span>' :
                        '<span class="status-valid">OK</span>'}</td>
                    <td><button class="btn btn-danger" onclick="removeSkylight(${s.id})">X</button></td>
                </tr>
                ${hasMultiple ? `<tr><td colspan="14" style="padding:0;"><div class="choice-note">
                    Luce ${s.luce}cm: disponibili ${s.hReteOptions.map(o=>`H.${o.height}`).join(' o ')}. Selezionare l'altezza appropriata.
                </div></td></tr>` : ''}
            `;
        }).join('');

        calculateBOM();
    }

    function selectHeight(id, indexStr) {
        const s = skylights.find(x => x.id === id);
        if (!s || !s.hReteOptions) return;
        s.selectedHeightIndex = parseInt(indexStr);
        const sel = s.hReteOptions[s.selectedHeightIndex];
        s.hRete = sel.height;
        s.spacing = sel.spacing;
        calculateBOM();
    }

    function updateSkylight(id, field, value) {
        const s = skylights.find(x => x.id === id);
        if (!s) return;

        if (field === 'qty') s.qty = Math.max(1, parseInt(value) || 1);
        else if (['luce', 'lunghezza', 'passoGreche'].includes(field)) s[field] = parseFloat(value) || 0;
        else if (field === 'schema') {
            s.schema = value;
            if (isExternalSchema(value)) s.netType = 'coperplax';
            s.selectedHeightIndex = 0;
        }
        else s[field] = value;

        calculateSkylight(s);
        renderTable();
    }

    function calculateSkylight(s) {
        s.hRete = null;
        s.hReteOptions = null;
        s.lTecnica = null;
        s.spacing = null;
        s.error = null;

        if (!s.luce || s.luce <= 0 || !s.lunghezza || s.lunghezza <= 0) return;

        const netType = isExternalSchema(s.schema) ? 'coperplax' : s.netType;
        const result = findNetHeightOptions(s.schema, s.luce, netType);

        if (result.error) {
            s.error = result.error;
            return;
        }

        s.hReteOptions = result.options;
        const idx = Math.min(s.selectedHeightIndex, result.options.length - 1);
        s.selectedHeightIndex = idx;
        const sel = result.options[idx];

        s.hRete = sel.height;
        s.spacing = needsPassoGreche(s.schema) ? calculatePlateSpacing(s.schema, s.passoGreche) : sel.spacing;
        s.lTecnica = calculateLTecnica(s.schema, s.lunghezza);
    }

    // ================================================================
    // OTTIMIZZAZIONE SFRIDI
    // ================================================================

    function updateOptimizationInfo() {
        const mode = document.getElementById('optimizationMode').value;
        const info = document.getElementById('optimizationInfo');
        
        const descriptions = {
            standard: '<strong>Modalità Standard:</strong> Ogni lucernario utilizza rotoli dedicati. Nessun riutilizzo di avanzi tra lucernari diversi. Massima semplicità di gestione.',
            optimized: '<strong>Massimo Risparmio:</strong> Riutilizza avanzi ≥5m tra lucernari diversi. Minimizza il numero di giunzioni mantenendo il massimo risparmio. Ideale per cantieri grandi.',
            balanced: '<strong>Modalità Equilibrata (Consigliata):</strong> Riutilizza avanzi ≥4m con massimo 1 giunzione longitudinale per lucernario. Ottimo compromesso tra risparmio e praticità.'
        };
        
        info.innerHTML = descriptions[mode];
    }

    // Variabile globale per memorizzare i risultati dell'ottimizzazione
    let optimizationResults = null;

    // Calcola il numero di giunzioni necessarie considerando l'overlap
    // Formula corretta: il primo pezzo copre rollLength, ogni successivo copre (rollLength - overlap)
    function calculateJunctionsRequired(effectiveLength, rollLength, overlap) {
        if (effectiveLength <= rollLength) return 0;
        const remaining = effectiveLength - rollLength;
        const effectiveRollWithOverlap = rollLength - overlap;
        return Math.ceil(remaining / effectiveRollWithOverlap);
    }

    // Calcola la sovrapposizione richiesta per giunzioni longitudinali
    function getOverlapForJunction(schema, hRete) {
        // Schemi A1, B1, C1, A2, B2, C2, D2, E2: sempre 100cm
        if (schema.endsWith('1') || schema.endsWith('2')) {
            return 1.0; // 100cm
        }
        // Schemi A, B, C, D, E: dipende dall'altezza
        if (hRete >= 223) {
            return 1.0; // 100cm per H.223+
        }
        return 0.5; // 50cm per H.102-203
    }

    function calculateOptimizedRolls(skylightsToOptimize) {
        const mode = document.getElementById('optimizationMode').value;
        const ROLL_LENGTH = 25.0;
        
        // Soglie diverse per modalità
        const MIN_REMNANT = mode === 'balanced' ? 4.0 : 5.0;
        const MAX_JUNCTIONS_PER_SKYLIGHT = mode === 'balanced' ? 1 : Infinity;

        // Raggruppa per tipo rete + altezza (SEPARAZIONE ASSOLUTA)
        const groups = {};
        
        skylightsToOptimize.forEach(s => {
            const netType = isExternalSchema(s.schema) ? 'coperplax' : s.netType;
            const isJointed = isJointedSchema(s.schema);
            const overlap = getOverlapForJunction(s.schema, s.hRete);
            
            // Espandi per quantità
            for (let i = 0; i < s.qty; i++) {
                const key = `${netType}-${s.hRete}`;
                if (!groups[key]) {
                    groups[key] = {
                        netType: netType,
                        height: s.hRete,
                        skylights: [],
                        rolls: []
                    };
                }
                groups[key].skylights.push({
                    ...s,
                    instanceId: `${s.id}-${i + 1}`,
                    displayName: s.name || `Lucernario ${s.id}`,
                    instanceNum: i + 1,
                    isJointed: isJointed,
                    effectiveLength: s.lTecnica,
                    overlapRequired: overlap
                });
            }
        });

        // Applica algoritmo per ogni gruppo
        Object.values(groups).forEach(group => {
            switch (mode) {
                case 'standard':
                    optimizeStandard(group, ROLL_LENGTH);
                    break;
                case 'optimized':
                    optimizeMaxSaving(group, ROLL_LENGTH, MIN_REMNANT);
                    break;
                case 'balanced':
                    optimizeBalanced(group, ROLL_LENGTH, MIN_REMNANT, MAX_JUNCTIONS_PER_SKYLIGHT);
                    break;
            }
        });

        // Calcola statistiche
        let totalRollsOptimized = 0;
        let totalRollsWithoutOpt = 0;
        let totalJunctionsUsed = 0;
        
        Object.values(groups).forEach(group => {
            // Schemi giuntati richiedono 2 rotoli affiancati
            const isJointed = group.skylights.some(s => s.isJointed);
            const netMultiplier = isJointed ? 2 : 1;
            
            totalRollsOptimized += group.rolls.length * netMultiplier;
            // Conta il numero di rotoli che sarebbero serviti senza ottimizzazione
            group.skylights.forEach(s => {
                totalRollsWithoutOpt += Math.ceil(s.effectiveLength / ROLL_LENGTH) * netMultiplier;
            });
            // Conta giunzioni usate
            group.rolls.forEach(roll => {
                roll.allocations.forEach(alloc => {
                    if (alloc.isJunction) totalJunctionsUsed++;
                });
            });
        });

        return {
            groups: groups,
            totalRolls: totalRollsOptimized,
            totalRollsWithoutOpt: totalRollsWithoutOpt,
            totalJunctions: totalJunctionsUsed,
            savings: totalRollsWithoutOpt > 0 ? Math.round((1 - totalRollsOptimized / totalRollsWithoutOpt) * 100) : 0,
            mode: mode
        };
    }

    // MODALITÀ STANDARD: rotoli interi dedicati + spezzoni ottimizzati
    // Logica: ogni lucernario usa rotoli interi dedicati, ma gli spezzoni 
    // (pezzi < 25m necessari per completare lucernari > 25m) vengono ottimizzati insieme
    function optimizeStandard(group, rollLength) {
        const SMALL_PIECE_THRESHOLD = 3.0; // Soglia per nota "spezzone piccolo"
        
        // FASE 1: Separa lucernari che richiedono solo rotoli interi da quelli che richiedono spezzoni
        const fullRollsNeeded = []; // {skylight, numFullRolls}
        const piecesNeeded = []; // {skylight, pieceLength, overlap, isSmall}
        
        group.skylights.forEach(s => {
            const overlap = s.overlapRequired;
            
            if (s.effectiveLength <= rollLength) {
                // Entra in 1 rotolo - rotolo dedicato
                group.rolls.push({
                    id: group.rolls.length + 1,
                    remaining: rollLength - s.effectiveLength,
                    allocations: [{
                        skylight: s,
                        length: s.effectiveLength,
                        isJunction: false
                    }]
                });
            } else {
                // Richiede più rotoli
                let remainingLength = s.effectiveLength;
                let pieceNum = 0;
                
                while (remainingLength > 0) {
                    const isFirstPiece = pieceNum === 0;
                    const effectiveRollLength = isFirstPiece ? rollLength : (rollLength - overlap);
                    
                    if (remainingLength >= effectiveRollLength) {
                        // Pezzo intero (25m o 25m - overlap)
                        group.rolls.push({
                            id: group.rolls.length + 1,
                            remaining: 0,
                            allocations: [{
                                skylight: s,
                                length: effectiveRollLength,
                                isJunction: !isFirstPiece,
                                junctionNum: !isFirstPiece ? pieceNum : null,
                                overlapUsed: !isFirstPiece ? overlap : 0
                            }]
                        });
                        remainingLength -= effectiveRollLength;
                    } else {
                        // Spezzone finale - da ottimizzare
                        // pieceLength include l'overlap fisico che si sovrappone al pezzo precedente
                        // L'overlap NON è lunghezza "in più" da coprire, ma materiale che si sovrappone
                        const pieceLength = remainingLength + (isFirstPiece ? 0 : overlap);
                        piecesNeeded.push({
                            skylight: s,
                            pieceLength: remainingLength,
                            actualLength: pieceLength, // include sovrapposizione
                            overlap: isFirstPiece ? 0 : overlap,
                            isSmall: pieceLength < SMALL_PIECE_THRESHOLD,
                            junctionNum: pieceNum
                        });
                        remainingLength = 0;
                    }
                    pieceNum++;
                }
            }
        });
        
        // FASE 2: Ottimizza spezzoni con Best Fit Decreasing
        if (piecesNeeded.length > 0) {
            // Ordina per lunghezza decrescente
            piecesNeeded.sort((a, b) => b.actualLength - a.actualLength);
            
            const pieceRolls = []; // Rotoli dedicati agli spezzoni
            
            piecesNeeded.forEach(piece => {
                // Cerca rotolo esistente con spazio sufficiente
                let bestRoll = null;
                let bestRemaining = Infinity;
                
                for (let roll of pieceRolls) {
                    if (roll.remaining >= piece.actualLength && roll.remaining < bestRemaining) {
                        bestRoll = roll;
                        bestRemaining = roll.remaining;
                    }
                }
                
                if (bestRoll) {
                    // Aggiungi a rotolo esistente
                    bestRoll.allocations.push({
                        skylight: piece.skylight,
                        length: piece.pieceLength,
                        isJunction: true,
                        junctionNum: piece.junctionNum,
                        overlapUsed: piece.overlap,
                        isSmallPiece: piece.isSmall
                    });
                    bestRoll.remaining -= piece.actualLength;
                } else {
                    // Nuovo rotolo per spezzoni
                    pieceRolls.push({
                        id: 0, // ID assegnato dopo
                        remaining: rollLength - piece.actualLength,
                        allocations: [{
                            skylight: piece.skylight,
                            length: piece.pieceLength,
                            isJunction: true,
                            junctionNum: piece.junctionNum,
                            overlapUsed: piece.overlap,
                            isSmallPiece: piece.isSmall
                        }]
                    });
                }
            });
            
            // Aggiungi rotoli spezzoni al gruppo con ID progressivi
            pieceRolls.forEach(roll => {
                roll.id = group.rolls.length + 1;
                group.rolls.push(roll);
            });
        }
    }

    // HELPER: Trova combinazione di avanzi che copre la lunghezza richiesta
    // Restituisce array di {roll, useLength} o null se non trovata
    function findRemnantCombination(rolls, targetLength, overlap, minRemnant, maxPieces) {
        // Filtra rotoli con avanzi utilizzabili
        const usableRolls = rolls
            .filter(r => r.remaining >= minRemnant)
            .sort((a, b) => b.remaining - a.remaining); // Ordina per avanzo decrescente
        
        if (usableRolls.length === 0) return null;
        
        // Caso 1: Un singolo avanzo copre tutto
        for (let roll of usableRolls) {
            if (roll.remaining >= targetLength) {
                return [{ roll, useLength: targetLength, isFirst: true }];
            }
        }
        
        if (maxPieces < 2) return null;
        
        // Caso 2: Due avanzi combinati (1 giunzione tra loro)
        for (let i = 0; i < usableRolls.length; i++) {
            for (let j = i + 1; j < usableRolls.length; j++) {
                const combined = usableRolls[i].remaining + usableRolls[j].remaining - overlap;
                if (combined >= targetLength) {
                    return [
                        { roll: usableRolls[i], useLength: usableRolls[i].remaining, isFirst: true },
                        { roll: usableRolls[j], useLength: targetLength - usableRolls[i].remaining + overlap, isFirst: false }
                    ];
                }
            }
        }
        
        if (maxPieces < 3) return null;
        
        // Caso 3+: Tre o più avanzi (solo per MASSIMO RISPARMIO)
        // Approccio greedy: prendi i più grandi finché non copri
        let accumulated = 0;
        let pieces = [];
        let overlapsUsed = 0;
        
        for (let roll of usableRolls) {
            if (pieces.length >= maxPieces) break;
            
            const effectiveAdd = pieces.length === 0 ? roll.remaining : (roll.remaining - overlap);
            pieces.push({ roll, useLength: roll.remaining, isFirst: pieces.length === 0 });
            accumulated += effectiveAdd;
            
            if (accumulated >= targetLength) {
                // Aggiusta l'ultimo pezzo per usare solo quanto serve
                const excess = accumulated - targetLength;
                pieces[pieces.length - 1].useLength -= excess;
                return pieces;
            }
        }
        
        return null; // Non trovata combinazione valida
    }

    // MODALITÀ MASSIMO RISPARMIO: riutilizza avanzi, combina più avanzi se necessario
    function optimizeMaxSaving(group, rollLength, minRemnant) {
        const SMALL_PIECE_THRESHOLD = 3.0;
        const MAX_PIECES = 10; // Limite pratico combinazioni
        
        // FASE 1: Identifica lucernari che possono essere coperti con 1 rotolo intero
        const singleRollSkylights = [];
        const multiRollSkylights = [];
        
        group.skylights.forEach(s => {
            if (s.effectiveLength <= rollLength) {
                singleRollSkylights.push(s);
            } else {
                multiRollSkylights.push(s);
            }
        });

        // FASE 2: Processa lucernari multi-rotolo
        multiRollSkylights.forEach(s => {
            const overlap = s.overlapRequired;
            let remainingLength = s.effectiveLength;
            let junctionCount = 0;
            
            while (remainingLength > 0) {
                const isFirstPiece = junctionCount === 0;
                
                // Prima prova a usare avanzi esistenti
                const combination = findRemnantCombination(
                    group.rolls, 
                    remainingLength + (isFirstPiece ? 0 : overlap),
                    overlap, 
                    minRemnant, 
                    MAX_PIECES
                );
                
                if (combination) {
                    // Usa la combinazione di avanzi trovata
                    combination.forEach((piece, idx) => {
                        piece.roll.allocations.push({
                            skylight: s,
                            length: piece.useLength - (idx > 0 ? overlap : 0),
                            isJunction: !isFirstPiece || idx > 0,
                            junctionNum: junctionCount + idx,
                            usedRemnant: true,
                            overlapUsed: idx > 0 ? overlap : 0
                        });
                        piece.roll.remaining -= piece.useLength;
                    });
                    remainingLength = 0;
                } else {
                    // Usa rotolo nuovo
                    const effectiveRollLength = isFirstPiece ? rollLength : (rollLength - overlap);
                    const usedLength = Math.min(remainingLength, effectiveRollLength);
                    const isSmall = usedLength < SMALL_PIECE_THRESHOLD;
                    
                    group.rolls.push({
                        id: group.rolls.length + 1,
                        remaining: rollLength - usedLength - (isFirstPiece ? 0 : overlap),
                        allocations: [{
                            skylight: s,
                            length: usedLength,
                            isJunction: !isFirstPiece,
                            junctionNum: !isFirstPiece ? junctionCount : null,
                            overlapUsed: !isFirstPiece ? overlap : 0,
                            isSmallPiece: isSmall
                        }]
                    });
                    
                    remainingLength -= usedLength;
                }
                junctionCount++;
            }
        });

        // FASE 3: Ottimizza i lucernari singoli con Best Fit + combinazione avanzi
        const sortedSingle = [...singleRollSkylights].sort((a, b) => b.effectiveLength - a.effectiveLength);
        
        sortedSingle.forEach(s => {
            const overlap = s.overlapRequired;
            
            // Cerca combinazione di avanzi (anche multipli)
            const combination = findRemnantCombination(group.rolls, s.effectiveLength, overlap, minRemnant, MAX_PIECES);
            
            if (combination) {
                if (combination.length === 1) {
                    // Singolo avanzo - nessuna giunzione aggiunta
                    combination[0].roll.allocations.push({
                        skylight: s,
                        length: s.effectiveLength,
                        isJunction: false,
                        usedRemnant: true
                    });
                    combination[0].roll.remaining -= s.effectiveLength;
                } else {
                    // Multipli avanzi - giunzioni tra loro
                    combination.forEach((piece, idx) => {
                        piece.roll.allocations.push({
                            skylight: s,
                            length: piece.useLength - (idx > 0 ? overlap : 0),
                            isJunction: idx > 0,
                            junctionPart: idx + 1,
                            usedRemnant: true,
                            overlapUsed: idx > 0 ? overlap : 0
                        });
                        piece.roll.remaining -= piece.useLength;
                    });
                }
            } else {
                // Prova avanzo + nuovo rotolo
                let bestRoll = null;
                let bestRemaining = 0;
                
                for (let roll of group.rolls) {
                    if (roll.remaining >= minRemnant) {
                        const totalCoverage = roll.remaining + rollLength - overlap;
                        if (totalCoverage >= s.effectiveLength && roll.remaining > bestRemaining) {
                            bestRoll = roll;
                            bestRemaining = roll.remaining;
                        }
                    }
                }
                
                if (bestRoll) {
                    const usedFromRemnant = bestRoll.remaining;
                    const neededFromNew = s.effectiveLength - usedFromRemnant + overlap;
                    const isSmall = neededFromNew < SMALL_PIECE_THRESHOLD;
                    
                    bestRoll.allocations.push({
                        skylight: s,
                        length: usedFromRemnant,
                        isJunction: true,
                        junctionPart: 1,
                        usedRemnant: true
                    });
                    bestRoll.remaining = 0;
                    
                    group.rolls.push({
                        id: group.rolls.length + 1,
                        remaining: rollLength - neededFromNew,
                        allocations: [{
                            skylight: s,
                            length: neededFromNew - overlap,
                            isJunction: true,
                            junctionPart: 2,
                            overlapUsed: overlap,
                            isSmallPiece: isSmall
                        }]
                    });
                } else {
                    // Rotolo dedicato
                    group.rolls.push({
                        id: group.rolls.length + 1,
                        remaining: rollLength - s.effectiveLength,
                        allocations: [{
                            skylight: s,
                            length: s.effectiveLength,
                            isJunction: false
                        }]
                    });
                }
            }
        });
    }

    // MODALITÀ EQUILIBRATA: max 1 giunzione per lucernario, avanzi ≥4m
    // Può combinare 2 avanzi con 1 giunzione tra loro
    function optimizeBalanced(group, rollLength, minRemnant, maxJunctions) {
        const SMALL_PIECE_THRESHOLD = 3.0;
        // Ordina per lunghezza decrescente
        const sorted = [...group.skylights].sort((a, b) => b.effectiveLength - a.effectiveLength);
        
        sorted.forEach(s => {
            const overlap = s.overlapRequired;
            
            // Se richiede più di 1 giunzione, usa rotoli dedicati
            const junctionsNeeded = calculateJunctionsRequired(s.effectiveLength, rollLength, overlap);
            
            if (junctionsNeeded > maxJunctions) {
                // Rotoli dedicati senza ottimizzazione
                let remainingLength = s.effectiveLength;
                let junctionCount = 0;
                
                while (remainingLength > 0) {
                    const isFirstPiece = junctionCount === 0;
                    const effectiveRollLength = isFirstPiece ? rollLength : (rollLength - overlap);
                    const usedLength = Math.min(remainingLength, effectiveRollLength);
                    const isSmall = usedLength < SMALL_PIECE_THRESHOLD;
                    
                    group.rolls.push({
                        id: group.rolls.length + 1,
                        remaining: rollLength - usedLength - (isFirstPiece ? 0 : overlap),
                        allocations: [{
                            skylight: s,
                            length: usedLength,
                            isJunction: !isFirstPiece,
                            junctionNum: !isFirstPiece ? junctionCount : null,
                            overlapUsed: !isFirstPiece ? overlap : 0,
                            isSmallPiece: isSmall
                        }]
                    });
                    
                    remainingLength -= usedLength;
                    junctionCount++;
                }
                return;
            }
            
            // OPZIONE 1: Prova a usare 1 avanzo senza giunzione
            if (s.effectiveLength <= rollLength) {
                let bestRoll = null;
                let bestRemaining = Infinity;
                
                for (let roll of group.rolls) {
                    if (roll.remaining >= s.effectiveLength && roll.remaining >= minRemnant) {
                        if (roll.remaining < bestRemaining) {
                            bestRoll = roll;
                            bestRemaining = roll.remaining;
                        }
                    }
                }
                
                if (bestRoll) {
                    bestRoll.allocations.push({
                        skylight: s,
                        length: s.effectiveLength,
                        isJunction: false,
                        usedRemnant: true
                    });
                    bestRoll.remaining -= s.effectiveLength;
                    return;
                }
                
                // OPZIONE 2: Prova a combinare 2 avanzi con 1 giunzione
                // Cerca 2 rotoli i cui avanzi sommati (meno overlap) coprano la lunghezza
                let bestCombination = null;
                let bestWaste = Infinity;
                
                for (let i = 0; i < group.rolls.length; i++) {
                    if (group.rolls[i].remaining < minRemnant) continue;
                    
                    for (let j = i + 1; j < group.rolls.length; j++) {
                        if (group.rolls[j].remaining < minRemnant) continue;
                        
                        const combined = group.rolls[i].remaining + group.rolls[j].remaining - overlap;
                        if (combined >= s.effectiveLength) {
                            const waste = combined - s.effectiveLength;
                            if (waste < bestWaste) {
                                bestCombination = { roll1: group.rolls[i], roll2: group.rolls[j] };
                                bestWaste = waste;
                            }
                        }
                    }
                }
                
                if (bestCombination) {
                    const { roll1, roll2 } = bestCombination;
                    const fromRoll1 = roll1.remaining;
                    const fromRoll2 = s.effectiveLength - fromRoll1 + overlap; // Rete fisica necessaria
                    const isSmall1 = fromRoll1 < SMALL_PIECE_THRESHOLD;
                    const isSmall2 = fromRoll2 < SMALL_PIECE_THRESHOLD;
                    
                    roll1.allocations.push({
                        skylight: s,
                        length: fromRoll1,
                        isJunction: true,
                        junctionPart: 1,
                        usedRemnant: true,
                        isSmallPiece: isSmall1
                    });
                    roll1.remaining = 0;
                    
                    roll2.allocations.push({
                        skylight: s,
                        length: fromRoll2 - overlap, // Copertura effettiva (rete fisica - overlap)
                        isJunction: true,
                        junctionPart: 2,
                        usedRemnant: true,
                        overlapUsed: overlap,
                        isSmallPiece: isSmall2
                    });
                    roll2.remaining -= fromRoll2;
                    return;
                }
            }
            
            // OPZIONE 3: Prova avanzo + nuovo rotolo con 1 giunzione (se consentito)
            if (maxJunctions >= 1 && s.effectiveLength > rollLength) {
                let bestRollWithJunction = null;
                let bestRemainingWithJunction = 0;
                
                for (let roll of group.rolls) {
                    if (roll.remaining >= minRemnant) {
                        const totalCoverage = roll.remaining + rollLength - overlap;
                        if (totalCoverage >= s.effectiveLength && roll.remaining > bestRemainingWithJunction) {
                            bestRollWithJunction = roll;
                            bestRemainingWithJunction = roll.remaining;
                        }
                    }
                }
                
                if (bestRollWithJunction) {
                    const usedFromRemnant = bestRollWithJunction.remaining;
                    const neededFromNew = s.effectiveLength - usedFromRemnant + overlap;
                    const isSmall1 = usedFromRemnant < SMALL_PIECE_THRESHOLD;
                    const isSmall2 = neededFromNew < SMALL_PIECE_THRESHOLD;
                    
                    bestRollWithJunction.allocations.push({
                        skylight: s,
                        length: usedFromRemnant,
                        isJunction: true,
                        junctionPart: 1,
                        usedRemnant: true,
                        isSmallPiece: isSmall1
                    });
                    bestRollWithJunction.remaining = 0;
                    
                    group.rolls.push({
                        id: group.rolls.length + 1,
                        remaining: rollLength - neededFromNew,
                        allocations: [{
                            skylight: s,
                            length: neededFromNew - overlap, // Copertura effettiva (rete fisica - overlap)
                            isJunction: true,
                            junctionPart: 2,
                            overlapUsed: overlap,
                            isSmallPiece: isSmall2
                        }]
                    });
                    return;
                }
            }
            
            // FALLBACK: rotolo dedicato
            if (s.effectiveLength <= rollLength) {
                group.rolls.push({
                    id: group.rolls.length + 1,
                    remaining: rollLength - s.effectiveLength,
                    allocations: [{
                        skylight: s,
                        length: s.effectiveLength,
                        isJunction: false
                    }]
                });
            } else {
                // Richiede giunzione
                let remainingLength = s.effectiveLength;
                let junctionCount = 0;
                
                while (remainingLength > 0) {
                    const isFirstPiece = junctionCount === 0;
                    const effectiveRollLength = isFirstPiece ? rollLength : (rollLength - overlap);
                    const usedLength = Math.min(remainingLength, effectiveRollLength);
                    const isSmall = usedLength < SMALL_PIECE_THRESHOLD;
                    
                    group.rolls.push({
                        id: group.rolls.length + 1,
                        remaining: rollLength - usedLength - (isFirstPiece ? 0 : overlap),
                        allocations: [{
                            skylight: s,
                            length: usedLength,
                            isJunction: !isFirstPiece,
                            junctionNum: !isFirstPiece ? junctionCount : null,
                            overlapUsed: !isFirstPiece ? overlap : 0,
                            isSmallPiece: isSmall
                        }]
                    });
                    
                    remainingLength -= usedLength;
                    junctionCount++;
                }
            }
        });
    }

    // ================================================================
    // VALIDAZIONE INPUT
    // ================================================================

    function validateSkylightInput(skylight) {
        const errors = [];
        const warnings = [];

        // 1. Lunghezza Vano
        if (!skylight.lunghezza || skylight.lunghezza <= 0) {
            errors.push("Lunghezza vano deve essere maggiore di 0");
        }
        if (skylight.lunghezza > 100) {
            warnings.push(`Lunghezza ${skylight.lunghezza}m è molto elevata - verificare`);
        }

        // 2. Schema valido
        const validSchemas = ['A','B','C','A1','B1','C1','A2','B2','C2','D','E','D2','E2'];
        if (!validSchemas.includes(skylight.schema)) {
            errors.push(`Schema "${skylight.schema}" non valido`);
        }

        // 3. Altezza Rete (basata su lookup tables reali)
        const validHeights = [102, 122, 152, 183, 203, 223, 244, 253];
        if (skylight.hRete && !validHeights.includes(parseInt(skylight.hRete))) {
            errors.push(`Altezza rete ${skylight.hRete}cm non disponibile`);
        }

        // 4. Net Type per Schema Esterno (D/E/D2/E2 richiedono COPERPLAX)
        if (['D', 'E', 'D2', 'E2'].includes(skylight.schema)) {
            if (skylight.netType && skylight.netType !== 'coperplax') {
                errors.push(`Schema ${skylight.schema} richiede COPERPLAX obbligatoriamente`);
            }
        }

        // 5. Passo Greche (obbligatorio per E/E2)
        if (['E', 'E2'].includes(skylight.schema)) {
            if (!skylight.passoGreche || skylight.passoGreche <= 0) {
                warnings.push("Passo greche non specificato per schema E/E2");
            }
        }

        return {
            isValid: errors.length === 0,
            errors,
            warnings
        };
    }

    // ================================================================
    // CALCOLO BOM
    // ================================================================

    function calculateBOM() {
        try {
            bom = { reti: {}, interno: {}, esterno: {}, giunzione: {} };
            optimizationResults = null;

            const validSkylights = skylights.filter(s => s.hRete && s.lTecnica);

            // Validazione input
            for (const s of validSkylights) {
                const validation = validateSkylightInput(s);
                if (!validation.isValid) {
                    console.warn(`Skylight ${s.id} validation errors:`, validation.errors);
                }
                if (validation.warnings.length > 0) {
                    console.warn(`Skylight ${s.id} warnings:`, validation.warnings);
                }
            }

            if (validSkylights.length === 0) {
                document.getElementById('bomSection').style.display = 'none';
                document.getElementById('calculationsSection').style.display = 'none';
                return;
            }

            // Calcola ottimizzazione sfridi
        optimizationResults = calculateOptimizedRolls(validSkylights);

        // Popola BOM reti dai risultati ottimizzazione
        Object.values(optimizationResults.groups).forEach(group => {
            const isJointed = group.skylights.some(s => s.isJointed);
            const netMultiplier = isJointed ? 2 : 1; // Schemi giuntati = 2 rotoli affiancati
            
            const netCode = getNetCode(group.netType, group.height);
            if (!bom.reti[netCode]) bom.reti[netCode] = { 
                code: netCode, 
                qty: 0, 
                product: PRODUCTS[netCode],
                rollDetails: []
            };
            bom.reti[netCode].qty += group.rolls.length * netMultiplier;
            bom.reti[netCode].rollDetails.push(...group.rolls.map(r => ({
                ...r,
                netType: group.netType,
                height: group.height
            })));
        });

        // Calcola accessori per ogni lucernario originale
        validSkylights.forEach(s => {
            const qty = s.qty;
            const isJointed = isJointedSchema(s.schema);

            // Calcola numero giunzioni longitudinali (sovrapposizioni nel senso della lunghezza)
            // Usa l'overlap corretto per schema e altezza
            const overlapLunghezza = getOverlapForJunction(s.schema, s.hRete);
            const effectiveRoll = ROLL_LENGTH_M - overlapLunghezza;
            let nGiunzioniLongitudinali = 0;
            if (s.lTecnica > ROLL_LENGTH_M) {
                const remaining = s.lTecnica - ROLL_LENGTH_M;
                nGiunzioniLongitudinali = Math.ceil(remaining / effectiveRoll);
            }
            
            // Zona infittimento: overlap × 2 (0.5m su ogni lato della giunzione)
            // Es: overlap 0.5m → 1m di zona infittita per giunzione
            // Es: overlap 1.0m → 2m di zona infittita per giunzione
            const zonaInfittimentoPerGiunzione = overlapLunghezza * 2;
            const zonaInfittimentoTotale = nGiunzioniLongitudinali * zonaInfittimentoPerGiunzione;

            // 2. ACCESSORI INTERNO/ESTERNO
            if (isInternalSchema(s.schema)) {
                // Passo viti:
                // - Schemi A1, B1, C1, A2, B2, C2: FISSO a 25.4cm (1 pollice)
                // - Schemi A, B, C: variabile dalla tabella CNR in base all'altezza
                const passoVitiCm = isJointed || s.schema.endsWith('1') ? 25.4 : s.spacing;
                const passoVitiM = passoVitiCm / 100;
                
                // Linee di fissaggio: sempre 2 (bordi laterali del lucernario)
                const nLati = 2;
                
                // Calcolo viti con infittimento nelle zone di sovrapposizione
                const lunghezzaNormale = s.lTecnica - zonaInfittimentoTotale;
                const lunghezzaInfittita = zonaInfittimentoTotale;
                
                // Viti zona normale (passo standard)
                const vitiZonaNormale = lunghezzaNormale > 0 ? Math.ceil(lunghezzaNormale / passoVitiM) : 0;
                
                // Viti zona infittita (passo dimezzato = doppio numero viti)
                const vitiZonaInfittita = lunghezzaInfittita > 0 ? Math.ceil(lunghezzaInfittita / (passoVitiM / 2)) : 0;
                
                const nVitiPerLinea = vitiZonaNormale + vitiZonaInfittita;
                
                // Infittimento inizio/fine lucernario (sempre presente)
                const infittimentoInizioFine = 12; // 6 inizio + 6 fine
                
                const nFissaggi = (nVitiPerLinea * nLati + infittimentoInizioFine) * qty;

                const screwCode = SCREW_MATRIX[s.struttura][s.profilo];
                if (!bom.interno[screwCode]) bom.interno[screwCode] = { code: screwCode, qty: 0, product: PRODUCTS[screwCode] };
                bom.interno[screwCode].qty += nFissaggi;

                // Salva i dettagli per la spiegazione calcoli
                s.calcoloViti = {
                    passoVitiCm: passoVitiCm,
                    nLati: nLati,
                    nVitiPerLinea: nVitiPerLinea,
                    vitiZonaNormale: vitiZonaNormale,
                    vitiZonaInfittita: vitiZonaInfittita,
                    lunghezzaNormale: lunghezzaNormale,
                    lunghezzaInfittita: lunghezzaInfittita,
                    nGiunzioni: nGiunzioniLongitudinali,
                    overlapLunghezza: overlapLunghezza,
                    infittimento: infittimentoInizioFine,
                    totale: nFissaggi / qty
                };

                // Nastro forato: metri lineari = L_Tecnica × 2 lati (NON cambia con infittimento)
                if (s.profilo === 'nastro') {
                    const nastroCodice = 'VQAS60025B';
                    const nastroMetri = s.lTecnica * nLati * qty;
                    if (!bom.interno[nastroCodice]) bom.interno[nastroCodice] = { code: nastroCodice, qty: 0, product: PRODUCTS[nastroCodice], isMeters: true };
                    bom.interno[nastroCodice].qty += nastroMetri;
                }
            }

            if (isExternalSchema(s.schema)) {
                // Passo piastre dalla tabella CNR (schemi D, E, D2, E2)
                const passoPiastreCm = s.spacing || 50;
                const passoPiastreM = passoPiastreCm / 100;
                
                // Linee di piastre: sempre 2 (bordi laterali del lucernario)
                const nLinee = 2;
                
                // Calcolo piastre con infittimento nelle zone di sovrapposizione
                const lunghezzaNormale = s.lTecnica - zonaInfittimentoTotale;
                const lunghezzaInfittita = zonaInfittimentoTotale;
                
                // Piastre zona normale (passo standard)
                const piastreZonaNormale = lunghezzaNormale > 0 ? Math.ceil(lunghezzaNormale / passoPiastreM) : 0;
                
                // Piastre zona infittita (passo dimezzato = doppio numero piastre)
                const piastreZonaInfittita = lunghezzaInfittita > 0 ? Math.ceil(lunghezzaInfittita / (passoPiastreM / 2)) : 0;
                
                const nPiastrePerLinea = piastreZonaNormale + piastreZonaInfittita;
                const nPiastre = nLinee * nPiastrePerLinea * qty;

                if (!bom.esterno['VQAS01142B']) bom.esterno['VQAS01142B'] = { code: 'VQAS01142B', qty: 0, product: PRODUCTS['VQAS01142B'] };
                bom.esterno['VQAS01142B'].qty += nPiastre;

                if (!bom.esterno['VQAS20142B']) bom.esterno['VQAS20142B'] = { code: 'VQAS20142B', qty: 0, product: PRODUCTS['VQAS20142B'] };
                bom.esterno['VQAS20142B'].qty += nPiastre;

                if (!bom.esterno['VQAS50100B']) bom.esterno['VQAS50100B'] = { code: 'VQAS50100B', qty: 0, product: PRODUCTS['VQAS50100B'] };
                bom.esterno['VQAS50100B'].qty += nPiastre * 2;
                
                // Salva dettagli per spiegazione calcoli
                s.calcoloPiastre = {
                    passoPiastreCm: passoPiastreCm,
                    nLinee: nLinee,
                    nPiastrePerLinea: nPiastrePerLinea,
                    piastreZonaNormale: piastreZonaNormale,
                    piastreZonaInfittita: piastreZonaInfittita,
                    lunghezzaNormale: lunghezzaNormale,
                    lunghezzaInfittita: lunghezzaInfittita,
                    nGiunzioni: nGiunzioniLongitudinali,
                    overlapLunghezza: overlapLunghezza,
                    totale: nPiastre / qty
                };
            }

            // 3. GIUNZIONE TRASVERSALE
            // Molle e punti servono SOLO per schemi giuntati (A2, B2, C2, D2, E2)
            // per la giunzione trasversale tra i 2 rotoli affiancati
            // NON servono per sovrapposizioni longitudinali
            
            if (isJointed) {
                // Lunghezza giunzione trasversale = L_Tecnica del lucernario
                const lunghezzaGiunzioneM = s.lTecnica;
                
                // FORMULA CORRETTA MOLLE: pattern 2-1-2-1 ogni 25.4cm = ~1.5 molle ogni 25.4cm
                // nMolle = (L_Tecnica / 0.254) × 1.5 + 8 margine per lucernario
                const nMollePerLuc = Math.ceil((lunghezzaGiunzioneM / 0.254) * 1.5) + 8;
                const nMolle = nMollePerLuc * qty;
                
                // FORMULA CORRETTA GRAFFE: passo 508mm (50.8cm = 20 pollici), 4 graffe per punto
                // nGraffe = (L_Tecnica / 0.508) × 4 + 8 margine per lucernario
                const nGraffePerLuc = Math.ceil((lunghezzaGiunzioneM / 0.508) * 4) + 8;
                const nGraffe = nGraffePerLuc * qty;

                // Salva i dettagli per la spiegazione calcoli
                s.calcoloGiunzione = {
                    lunghezzaM: lunghezzaGiunzioneM,
                    mollePerLuc: nMollePerLuc,
                    graffePerLuc: nGraffePerLuc
                };

                if (nMolle > 0) {
                    if (!bom.giunzione['VQAS55450B']) bom.giunzione['VQAS55450B'] = { code: 'VQAS55450B', qty: 0, product: PRODUCTS['VQAS55450B'] };
                    bom.giunzione['VQAS55450B'].qty += nMolle;
                }

                if (nGraffe > 0) {
                    if (!bom.giunzione['VQ2430B']) bom.giunzione['VQ2430B'] = { code: 'VQ2430B', qty: 0, product: PRODUCTS['VQ2430B'] };
                    bom.giunzione['VQ2430B'].qty += nGraffe;
                }
            }
        });

            renderCalculations(validSkylights);
            renderBOM();
        } catch (error) {
            console.error('Errore calcolo BOM:', error);

            // Mostra errore all'utente
            const bomSection = document.getElementById('bomSection');
            if (bomSection) {
                bomSection.innerHTML = `
                    <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 20px; margin: 20px; color: #991b1b;">
                        <h3 style="margin: 0 0 10px 0;">[!] Errore nel Calcolo</h3>
                        <p style="margin: 0;">${error.message}</p>
                        <p style="margin: 10px 0 0 0; font-size: 0.875rem; color: #6b7280;">
                            Verificare i dati inseriti e riprovare. Se il problema persiste, contattare supporto.
                        </p>
                    </div>
                `;
                bomSection.style.display = 'block';
            }

            document.getElementById('calculationsSection').style.display = 'none';
        }
    }

    // Nuova funzione per mostrare la spiegazione dei calcoli
    function renderCalculations(validSkylights) {
        const container = document.getElementById('calculationsContent');
        const section = document.getElementById('calculationsSection');
        
        if (validSkylights.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        
        let html = '';
        
        validSkylights.forEach((s, i) => {
            const netType = isExternalSchema(s.schema) ? 'coperplax' : s.netType;
            const isJointed = isJointedSchema(s.schema);
            const isExt = isExternalSchema(s.schema);
            const rollCalc = calculateRolls(s.lTecnica, s.hRete);
            const netMultiplier = isJointed ? 2 : 1;
            
            html += `<div class="calc-explanation">
                <div class="calc-explanation-header">
                    <span class="badge ${netType === 'copertec' ? 'badge-copertec' : 'badge-coperplax'}">${netType.toUpperCase()}</span>
                    <span class="calc-explanation-title">${s.name || 'Lucernario ' + (i+1)} - Schema ${s.schema}</span>
                    ${s.qty > 1 ? `<span style="color:var(--gray-500);font-size:0.85rem;">× ${s.qty}</span>` : ''}
                </div>
                <div class="calc-grid">
                    <!-- ROTOLI -->
                    <div class="calc-box">
                        <div class="calc-box-title"><span class="icon"></span> Rotoli Rete</div>
                        <div class="calc-formula">
L_Tecnica = ${s.lTecnica.toFixed(3)}m
Rotolo = 25m → ${rollCalc.rolls} rotoli/lucernario${isJointed ? `
Schema giuntato → ×2 affiancati` : ''}
                        </div>
                        <div class="calc-result">${rollCalc.rolls * netMultiplier} rotoli H.${s.hRete}cm ${s.qty > 1 ? `× ${s.qty} = ${rollCalc.rolls * netMultiplier * s.qty} tot.` : ''}</div>
                        ${rollCalc.junctions > 0 ? `<div class="calc-note">${rollCalc.junctions} sovrapposizione/i longitudinale/i</div>` : ''}
                    </div>`;
            
            // VITI (solo schemi interni)
            if (isInternalSchema(s.schema) && s.calcoloViti) {
                const cv = s.calcoloViti;
                let formulaViti = `Passo = ${cv.passoVitiCm}cm${cv.passoVitiCm === 25.4 ? ' (1 pollice)' : ''}
Linee fissaggio = ${cv.nLati} (2 bordi)`;
                
                if (cv.nGiunzioni > 0) {
                    // Con zone di infittimento per sovrapposizioni
                    formulaViti += `
-----------------------------
Zona normale: ${cv.lunghezzaNormale.toFixed(2)}m
  → ceil(${cv.lunghezzaNormale.toFixed(2)}m / ${(cv.passoVitiCm/100).toFixed(3)}m) = ${cv.vitiZonaNormale} viti/linea
Zona infittita: ${cv.lunghezzaInfittita.toFixed(2)}m (${cv.nGiunzioni} giunz. × ${cv.overlapLunghezza}m × 2 lati)
  → passo dimezzato ${(cv.passoVitiCm/2).toFixed(1)}cm
  → ceil(${cv.lunghezzaInfittita.toFixed(2)}m / ${(cv.passoVitiCm/200).toFixed(4)}m) = ${cv.vitiZonaInfittita} viti/linea
-----------------------------
Viti/linea totali = ${cv.vitiZonaNormale} + ${cv.vitiZonaInfittita} = ${cv.nVitiPerLinea}`;
                } else {
                    // Senza sovrapposizioni
                    formulaViti += `
Viti/linea = ceil(${s.lTecnica.toFixed(2)}m / ${(cv.passoVitiCm/100).toFixed(3)}m) = ${cv.nVitiPerLinea}`;
                }
                
                formulaViti += `
Infittimento bordi = +${cv.infittimento} (6 inizio + 6 fine)`;
                
                html += `
                    <div class="calc-box">
                        <div class="calc-box-title"> Viti/Ancoranti</div>
                        <div class="calc-formula">${formulaViti}</div>
                        <div class="calc-result">${cv.totale} viti/lucernario ${s.qty > 1 ? `× ${s.qty} = ${cv.totale * s.qty} tot.` : ''}</div>
                    </div>`;
            }
            
            // PIASTRE (solo schemi esterni)
            if (isExt && s.calcoloPiastre) {
                const cp = s.calcoloPiastre;
                let formulaPiastre = `Passo piastre = ${cp.passoPiastreCm}cm
Linee = ${cp.nLinee} (2 bordi)`;
                
                if (cp.nGiunzioni > 0) {
                    // Con zone di infittimento per sovrapposizioni
                    formulaPiastre += `
-----------------------------
Zona normale: ${cp.lunghezzaNormale.toFixed(2)}m
  → ceil(${cp.lunghezzaNormale.toFixed(2)}m / ${(cp.passoPiastreCm/100).toFixed(2)}m) = ${cp.piastreZonaNormale} piastre/linea
Zona infittita: ${cp.lunghezzaInfittita.toFixed(2)}m (${cp.nGiunzioni} giunz. × ${cp.overlapLunghezza}m × 2 lati)
  → passo dimezzato ${(cp.passoPiastreCm/2).toFixed(1)}cm
  → ceil(${cp.lunghezzaInfittita.toFixed(2)}m / ${(cp.passoPiastreCm/200).toFixed(3)}m) = ${cp.piastreZonaInfittita} piastre/linea
-----------------------------
Piastre/linea totali = ${cp.piastreZonaNormale} + ${cp.piastreZonaInfittita} = ${cp.nPiastrePerLinea}`;
                } else {
                    // Senza sovrapposizioni
                    formulaPiastre += `
Piastre/linea = ceil(${s.lTecnica.toFixed(2)}m / ${(cp.passoPiastreCm/100).toFixed(2)}m) = ${cp.nPiastrePerLinea}`;
                }
                
                const nPiastreTot = cp.totale;
                formulaPiastre += `
Piastre totali = ${cp.nLinee} linee × ${cp.nPiastrePerLinea} = ${nPiastreTot}
Rivetti = ${nPiastreTot} × 2 = ${nPiastreTot * 2}`;
                
                html += `
                    <div class="calc-box">
                        <div class="calc-box-title"><span class="icon"></span> Piastre + Guarnizioni + Rivetti</div>
                        <div class="calc-formula">${formulaPiastre}</div>
                        <div class="calc-result">${nPiastreTot} piastre, ${nPiastreTot} guarnizioni, ${nPiastreTot * 2} rivetti ${s.qty > 1 ? `× ${s.qty}` : ''}</div>
                    </div>`;
            }
            
            // MOLLE E GRAFFE (solo schemi giuntati)
            if (isJointed && s.calcoloGiunzione) {
                const cg = s.calcoloGiunzione;
                html += `
                    <div class="calc-box">
                        <div class="calc-box-title"> Accessori Giunzione Trasversale</div>
                        <div class="calc-formula">
Giunzione lungo = ${cg.lunghezzaM.toFixed(3)}m

MOLLE: (L/0.254) × 1.5 + 8
= (${cg.lunghezzaM.toFixed(3)}/0.254) × 1.5 + 8 = ${cg.mollePerLuc}

GRAFFE: (L/0.508) × 4 + 8
= (${cg.lunghezzaM.toFixed(3)}/0.508) × 4 + 8 = ${cg.graffePerLuc}
                        </div>
                        <div class="calc-result">${cg.mollePerLuc} molle, ${cg.graffePerLuc} graffe/lucernario ${s.qty > 1 ? `× ${s.qty}` : ''}</div>
                    </div>`;
            }
            
            html += `</div></div>`;
        });
        
        container.innerHTML = html;
    }

    function renderBOM() {
        const container = document.getElementById('bomContent');
        document.getElementById('bomSection').style.display = 'block';

        const discounts = {
            reti: [parseFloat(document.getElementById('discReti1').value) || 0, parseFloat(document.getElementById('discReti2').value) || 0],
            interno: [parseFloat(document.getElementById('discInterno1').value) || 0, parseFloat(document.getElementById('discInterno2').value) || 0],
            esterno: [parseFloat(document.getElementById('discEsterno1').value) || 0, parseFloat(document.getElementById('discEsterno2').value) || 0],
            giunzione: [parseFloat(document.getElementById('discGiunzione1').value) || 0, parseFloat(document.getElementById('discGiunzione2').value) || 0],
        };

        let subtotals = { reti: 0, interno: 0, esterno: 0, giunzione: 0 };
        let subtotalsDiscounted = { reti: 0, interno: 0, esterno: 0, giunzione: 0 };

        // Traccia profili non forniti
        const profiliNonForniti = new Set();
        const PROFILI_NON_FORNITI = {
            'piatto': 'Piatto acciaio 30x3mm',
            'profiloL': 'Profilo L 30x30x2mm',
            'legno': 'Listello legno'
        };

        skylights.filter(s => s.hRete && s.lTecnica && isInternalSchema(s.schema)).forEach(s => {
            if (PROFILI_NON_FORNITI[s.profilo]) {
                profiliNonForniti.add(PROFILI_NON_FORNITI[s.profilo]);
            }
        });

        let html = '';

        // RIEPILOGO OTTIMIZZAZIONE
        if (optimizationResults && (optimizationResults.savings > 0 || optimizationResults.mode !== 'standard')) {
            const modeLabels = {
                standard: 'Standard',
                optimized: 'Massimo Risparmio',
                balanced: 'Equilibrata'
            };
            html += `<div class="optimization-summary">
                <div class="optimization-summary-title">Riepilogo Ottimizzazione Sfridi (${modeLabels[optimizationResults.mode]})</div>
                <div class="optimization-stats">
                    <div class="optimization-stat">
                        <div class="optimization-stat-value">${optimizationResults.totalRolls}</div>
                        <div class="optimization-stat-label">Rotoli necessari</div>
                    </div>
                    <div class="optimization-stat">
                        <div class="optimization-stat-value">${optimizationResults.totalRollsWithoutOpt}</div>
                        <div class="optimization-stat-label">Senza ottimizzazione</div>
                    </div>
                    <div class="optimization-stat saving">
                        <div class="optimization-stat-value">${optimizationResults.savings > 0 ? '-' + optimizationResults.savings + '%' : '0%'}</div>
                        <div class="optimization-stat-label">Risparmio rotoli</div>
                    </div>
                    ${optimizationResults.totalJunctions > 0 ? `<div class="optimization-stat">
                        <div class="optimization-stat-value">${optimizationResults.totalJunctions}</div>
                        <div class="optimization-stat-label">Giunzioni longitudinali</div>
                    </div>` : ''}
                </div>
            </div>`;
        }

        // Reti
        if (Object.keys(bom.reti).length > 0) {
            html += `<div class="bom-category">
                <div class="bom-category-title cat-reti">RETI</div>
                <table class="bom-table">
                    <thead><tr><th>Codice</th><th>Descrizione</th><th>Qtà Rotoli</th><th>Prezzo Unit.</th><th>Totale</th></tr></thead>
                    <tbody>`;
            
            Object.values(bom.reti).forEach(item => {
                const p = item.product;
                if (!p) return;
                const total = item.qty * p.price;
                subtotals.reti += total;
                html += `<tr><td>${item.code}</td><td>${p.desc}</td><td>${item.qty}</td><td>${formatCurrency(p.price)}</td><td>${formatCurrency(total)}</td></tr>`;
            });

            subtotalsDiscounted.reti = applyDiscount(subtotals.reti, discounts.reti);
            html += `</tbody></table>`;

            // Dettaglio allocazioni rotoli (se ottimizzazione attiva)
            if (optimizationResults && optimizationResults.mode !== 'none') {
                html += `<details class="collapsible-section" style="margin-top:20px;">
                    <summary>Dettaglio Allocazioni Rotoli</summary>
                    <div class="details-content">`;
                
                Object.values(optimizationResults.groups).forEach(group => {
                    const netLabel = group.netType.toUpperCase();
                    html += `<div style="margin-bottom:10px;"><strong>${netLabel} H.${group.height}cm</strong></div>`;
                    
                    group.rolls.forEach(roll => {
                        html += `<div style="background:#fff;border:1px solid #e5e7eb;border-radius:4px;padding:8px;margin-bottom:6px;">
                            <div style="font-weight:600;font-size:0.85rem;margin-bottom:4px;">Rotolo #${roll.id} (25m)</div>`;
                        
                        roll.allocations.forEach(alloc => {
                            let junctionInfo = '';
                            let lengthDisplay = '';
                            
                            // Calcola rete fisica e copertura effettiva
                            const reteUsata = alloc.overlapUsed ? (alloc.length + alloc.overlapUsed) : alloc.length;
                            const coperturaEffettiva = alloc.length;
                            
                            if (alloc.isJunction) {
                                if (alloc.junctionPart) {
                                    junctionInfo = ` <span style="color:#f59e0b;font-weight:600;">Giun. #${alloc.junctionPart}</span>`;
                                } else if (alloc.junctionNum !== null && alloc.junctionNum !== undefined) {
                                    junctionInfo = ` <span style="color:#f59e0b;font-weight:600;">Giun.</span>`;
                                } else {
                                    junctionInfo = ` <span style="color:#f59e0b;font-weight:600;">Giun.</span>`;
                                }
                            }
                            if (alloc.usedRemnant) {
                                junctionInfo += ` <span style="color:#10b981;">Recup.</span>`;
                            }
                            if (alloc.isSmallPiece) {
                                junctionInfo += ` <span style="color:#ef4444;font-weight:600;" title="Spezzone corto: verificare praticità di posa">[!]</span>`;
                            }
                            
                            // Costruisci display lunghezza con dettaglio overlap
                            if (alloc.overlapUsed) {
                                // Pezzo con sovrapposizione: mostra rete fisica e copertura
                                lengthDisplay = `<span title="Rete fisica ${reteUsata.toFixed(2)}m di cui ${(alloc.overlapUsed * 100).toFixed(0)}cm sovrapposti al pezzo precedente">${reteUsata.toFixed(2)}m <span style="color:#6b7280;font-size:0.75rem;">(sovr. ${(alloc.overlapUsed * 100).toFixed(0)}cm)</span></span>`;
                            } else if (alloc.isJunction && alloc.junctionPart === 1) {
                                // Primo pezzo di giunzione: la rete sarà  SOTTO il pezzo successivo
                                lengthDisplay = `<span title="Rete ${alloc.length.toFixed(2)}m - parte finale sarà  sotto il pezzo successivo">${alloc.length.toFixed(2)}m</span>`;
                            } else {
                                lengthDisplay = `${alloc.length.toFixed(2)}m`;
                            }
                            
                            html += `<div class="roll-item">
                                <span>${alloc.skylight.displayName}${alloc.skylight.qty > 1 ? ' #' + alloc.skylight.instanceNum : ''}${junctionInfo}</span>
                                <span>${lengthDisplay}</span>
                            </div>`;
                        });
                        
                        const minRemnant = optimizationResults.mode === 'balanced' ? 4 : 5;
                        const remnantClass = roll.remaining >= minRemnant ? 'roll-item-remnant' : 'roll-item-remnant unusable';
                        const remnantNote = roll.remaining >= minRemnant ? `(riutilizzabile ≥${minRemnant}m)` : `(< ${minRemnant}m)`;
                        html += `<div class="roll-item">
                            <span style="font-style:italic;">Avanzo</span>
                            <span class="${remnantClass}">${roll.remaining.toFixed(2)}m ${remnantNote}</span>
                        </div>`;
                        
                        html += `</div>`;
                    });
                });
                
                html += `</div></details>`;
            }

            html += `</div>`;
        }

        // Accessori Interno
        if (Object.keys(bom.interno).length > 0) {
            html += `<div class="bom-category">
                <div class="bom-category-title cat-interno">ACCESSORI INTERNO</div>
                <table class="bom-table">
                    <thead><tr><th>Codice</th><th>Descrizione</th><th>Qtà</th><th>Conf.</th><th>N° Conf.</th><th>Prezzo Conf.</th><th>Totale</th></tr></thead>
                    <tbody>`;
            
            Object.values(bom.interno).forEach(item => {
                const p = item.product;
                if (!p) return;
                let nConf, total;
                if (item.isMeters) {
                    nConf = Math.ceil(item.qty / p.rollLength);
                    total = nConf * p.price;
                    html += `<tr><td>${item.code}</td><td>${p.desc}</td><td>${item.qty.toFixed(1)}m</td><td>${p.rollLength}m</td><td>${nConf}</td><td>${formatCurrency(p.price)}</td><td>${formatCurrency(total)}</td></tr>`;
                } else {
                    nConf = Math.ceil(item.qty / p.pcs);
                    total = nConf * p.price;
                    html += `<tr><td>${item.code}</td><td>${p.desc}</td><td>${Math.ceil(item.qty)}</td><td>${p.pcs}pz</td><td>${nConf}</td><td>${formatCurrency(p.price)}</td><td>${formatCurrency(total)}</td></tr>`;
                }
                subtotals.interno += total;
            });

            subtotalsDiscounted.interno = applyDiscount(subtotals.interno, discounts.interno);
            html += `</tbody></table>`;

            // Nota profili non forniti (se presenti)
            if (profiliNonForniti.size > 0) {
                const lista = Array.from(profiliNonForniti).join(', ');
                html += `<div class="note-non-fornito">
                    <strong>Materiali non forniti da Cavatorta:</strong> ${lista}<br>
                    <small>Questi profili di fissaggio sono necessari per l'installazione ma devono essere approvvigionati separatamente.</small>
                </div>`;
            }

            html += `</div>`;
        }

        // Accessori Esterno
        if (Object.keys(bom.esterno).length > 0) {
            html += `<div class="bom-category">
                <div class="bom-category-title cat-esterno">ACCESSORI ESTERNO</div>
                <table class="bom-table">
                    <thead><tr><th>Codice</th><th>Descrizione</th><th>Qtà</th><th>Conf.</th><th>N° Conf.</th><th>Prezzo Conf.</th><th>Totale</th></tr></thead>
                    <tbody>`;
            
            Object.values(bom.esterno).forEach(item => {
                const p = item.product;
                if (!p) return;
                const nConf = Math.ceil(item.qty / p.pcs);
                const total = nConf * p.price;
                subtotals.esterno += total;
                html += `<tr><td>${item.code}</td><td>${p.desc}</td><td>${Math.ceil(item.qty)}</td><td>${p.pcs}pz</td><td>${nConf}</td><td>${formatCurrency(p.price)}</td><td>${formatCurrency(total)}</td></tr>`;
            });

            subtotalsDiscounted.esterno = applyDiscount(subtotals.esterno, discounts.esterno);
            html += `</tbody></table></div>`;
        }

        // Accessori Giunzione
        if (Object.keys(bom.giunzione).length > 0) {
            html += `<div class="bom-category">
                <div class="bom-category-title cat-giunzione">ACCESSORI GIUNZIONE</div>
                <table class="bom-table">
                    <thead><tr><th>Codice</th><th>Descrizione</th><th>Qtà</th><th>Conf.</th><th>N° Conf.</th><th>Prezzo Conf.</th><th>Totale</th></tr></thead>
                    <tbody>`;
            
            Object.values(bom.giunzione).forEach(item => {
                const p = item.product;
                if (!p) return;
                const nConf = Math.ceil(item.qty / p.pcs);
                const total = nConf * p.price;
                subtotals.giunzione += total;
                html += `<tr><td>${item.code}</td><td>${p.desc}</td><td>${Math.ceil(item.qty)}</td><td>${p.pcs}pz</td><td>${nConf}</td><td>${formatCurrency(p.price)}</td><td>${formatCurrency(total)}</td></tr>`;
            });

            subtotalsDiscounted.giunzione = applyDiscount(subtotals.giunzione, discounts.giunzione);
            html += `</tbody></table></div>`;
        }

        // Nota giacenze
        html += `<div class="note-giacenze">
            Prima di confermare l'ordine, verificare le giacenze di tutti i materiali con il servizio clienti Cavatorta.
        </div>`;

        container.innerHTML = html;

        // Calcolo trasporti
        const transportType = document.getElementById('transportType').value;
        let transportCost = 0;
        
        if (transportType === 'destino') {
            const calcType = document.getElementById('transportCalcType').value;
            const value = parseFloat(document.getElementById('transportValue').value) || 0;
            const subtotaleMateriali = subtotalsDiscounted.reti + subtotalsDiscounted.interno + subtotalsDiscounted.esterno + subtotalsDiscounted.giunzione;
            
            if (calcType === 'fisso') {
                transportCost = value;
            } else {
                transportCost = subtotaleMateriali * value / 100;
            }
        }

        // Aggiorna tabella totali
        const totalListino = subtotals.reti + subtotals.interno + subtotals.esterno + subtotals.giunzione;
        const subtotaleScontato = subtotalsDiscounted.reti + subtotalsDiscounted.interno + subtotalsDiscounted.esterno + subtotalsDiscounted.giunzione;
        const totaleScontatoFinale = subtotaleScontato + transportCost;
        const totalListinoConTrasporto = totalListino + transportCost;
        
        // Calcola percentuali sconto
        function calcDiscountPerc(d) {
            if (d[0] === 0 && d[1] === 0) return '0%';
            if (d[1] === 0) return d[0] + '%';
            const combined = (1 - (1 - d[0]/100) * (1 - d[1]/100)) * 100;
            return combined.toFixed(1) + '%';
        }

        document.getElementById('listinoReti').textContent = formatCurrency(subtotals.reti);
        document.getElementById('scontoRetiPerc').textContent = calcDiscountPerc(discounts.reti);
        document.getElementById('scontatoReti').textContent = formatCurrency(subtotalsDiscounted.reti);

        document.getElementById('listinoInterno').textContent = formatCurrency(subtotals.interno);
        document.getElementById('scontoInternoPerc').textContent = calcDiscountPerc(discounts.interno);
        document.getElementById('scontatoInterno').textContent = formatCurrency(subtotalsDiscounted.interno);

        document.getElementById('listinoEsterno').textContent = formatCurrency(subtotals.esterno);
        document.getElementById('scontoEsternoPerc').textContent = calcDiscountPerc(discounts.esterno);
        document.getElementById('scontatoEsterno').textContent = formatCurrency(subtotalsDiscounted.esterno);

        document.getElementById('listinoGiunzione').textContent = formatCurrency(subtotals.giunzione);
        document.getElementById('scontoGiunzionePerc').textContent = calcDiscountPerc(discounts.giunzione);
        document.getElementById('scontatoGiunzione').textContent = formatCurrency(subtotalsDiscounted.giunzione);

        document.getElementById('subtotaleListino').innerHTML = `<strong>${formatCurrency(totalListino)}</strong>`;
        document.getElementById('subtotaleScontato').innerHTML = `<strong>${formatCurrency(subtotaleScontato)}</strong>`;

        // Trasporto
        const rowTransport = document.getElementById('rowTransport');
        if (transportCost > 0) {
            rowTransport.style.display = 'table-row';
            document.getElementById('trasportoListino').textContent = formatCurrency(transportCost);
            document.getElementById('trasportoScontato').textContent = formatCurrency(transportCost);
        } else {
            rowTransport.style.display = 'none';
        }

        // Totale finale
        const scontoTotale = totalListinoConTrasporto - totaleScontatoFinale;
        const scontoPercTotale = totalListinoConTrasporto > 0 ? (scontoTotale / totalListinoConTrasporto * 100) : 0;

        document.getElementById('totaleListinoFinale').textContent = formatCurrency(totalListinoConTrasporto);
        document.getElementById('scontoTotalePerc').textContent = scontoPercTotale > 0 ? `-${scontoPercTotale.toFixed(1)}%` : '-';
        document.getElementById('totaleScontatoFinale').textContent = formatCurrency(totaleScontatoFinale);
    }

    function applyDiscount(amount, discounts) {
        let result = amount;
        result = result * (1 - discounts[0] / 100);
        result = result * (1 - discounts[1] / 100);
        return result;
    }

    // ================================================================
    // TOOLTIP FUNCTION
    // ================================================================

    function toggleTooltip() {
        const overlay = document.getElementById('tooltipOverlay');
        const content = document.getElementById('tooltipContent');
        overlay.classList.toggle('show');
        content.classList.toggle('show');
    }

    // ================================================================
    // EXPORT FUNCTIONS
    // ================================================================

    function getExportData() {
        const cliente = {
            ragioneSociale: document.getElementById('clientName').value || 'N/D',
            referente: document.getElementById('clientContact').value || '',
            email: document.getElementById('clientEmail').value || '',
            telefono: document.getElementById('clientPhone').value || '',
            progetto: document.getElementById('projectName').value || '',
            data: document.getElementById('quoteDate').value || new Date().toISOString().split('T')[0]
        };

        const validSkylights = skylights.filter(s => s.hRete && s.lTecnica);
        
        // Calcola totali
        const totali = {
            listinoReti: document.getElementById('listinoReti').textContent,
            scontoRetiPerc: document.getElementById('scontoRetiPerc').textContent,
            scontatoReti: document.getElementById('scontatoReti').textContent,
            listinoInterno: document.getElementById('listinoInterno').textContent,
            scontoInternoPerc: document.getElementById('scontoInternoPerc').textContent,
            scontatoInterno: document.getElementById('scontatoInterno').textContent,
            listinoEsterno: document.getElementById('listinoEsterno').textContent,
            scontoEsternoPerc: document.getElementById('scontoEsternoPerc').textContent,
            scontatoEsterno: document.getElementById('scontatoEsterno').textContent,
            listinoGiunzione: document.getElementById('listinoGiunzione').textContent,
            scontoGiunzionePerc: document.getElementById('scontoGiunzionePerc').textContent,
            scontatoGiunzione: document.getElementById('scontatoGiunzione').textContent,
            totaleListino: document.getElementById('totaleListinoFinale').textContent,
            scontoTotale: document.getElementById('scontoTotalePerc').textContent,
            totaleFinale: document.getElementById('totaleScontatoFinale').textContent
        };

        return { cliente, skylights: validSkylights, bom, totali };
    }

    function exportPDF() {
        // Verifica se jsPDF è disponibile
        if (typeof window.jspdf === 'undefined') {
            alert('La libreria PDF non è disponibile in questa modalità di visualizzazione.\n\nPer scaricare il PDF:\n1. Salva il file HTML sul tuo computer\n2. Aprilo nel browser\n3. Riprova il download');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const data = getExportData();
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // Colori brand
        const colorVerde = [5, 150, 105];
        const colorBlu = [29, 78, 216];
        const colorGrigio = [100, 100, 100];
        const colorGrigioChiaro = [240, 240, 240];
        
        // ================================================================
        // HEADER
        // ================================================================
        
        // Linea decorativa verde top
        doc.setFillColor(...colorVerde);
        doc.rect(0, 0, pageWidth, 4, 'F');
        
        // Titolo principale
        doc.setFontSize(24);
        doc.setTextColor(...colorVerde);
        doc.setFont('helvetica', 'bold');
        doc.text('COPERTEC SYSTEM', 14, 20);
        
        // Sottotitolo
        doc.setFontSize(11);
        doc.setTextColor(...colorGrigio);
        doc.setFont('helvetica', 'normal');
        doc.text('Preventivo Reti Anticaduta - CNR A.T. 650/25', 14, 27);
        
        // Linea separatore sotto header
        doc.setDrawColor(...colorVerde);
        doc.setLineWidth(0.5);
        doc.line(14, 32, pageWidth - 14, 32);
        
        // ================================================================
        // DATI CLIENTE
        // ================================================================
        
        let yPos = 42;
        doc.setFontSize(12);
        doc.setTextColor(...colorVerde);
        doc.setFont('helvetica', 'bold');
        doc.text('DATI CLIENTE', 14, yPos);
        
        yPos += 8;
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.setFont('helvetica', 'normal');
        
        // Box grigio per dati cliente
        doc.setFillColor(...colorGrigioChiaro);
        doc.roundedRect(14, yPos - 4, pageWidth - 28, 24, 2, 2, 'F');
        
        doc.text(`Cliente: ${data.cliente.ragioneSociale || 'N/D'}`, 18, yPos + 2);
        doc.text(`Referente: ${data.cliente.referente || '-'}`, 18, yPos + 9);
        doc.text(`Progetto: ${data.cliente.progetto || '-'}`, pageWidth/2, yPos + 2);
        doc.text(`Data: ${data.cliente.data}`, pageWidth/2, yPos + 9);
        
        yPos += 28;
        
        // ================================================================
        // CONFIGURAZIONE LUCERNARI
        // ================================================================
        
        doc.setFontSize(12);
        doc.setTextColor(...colorVerde);
        doc.setFont('helvetica', 'bold');
        doc.text('CONFIGURAZIONE LUCERNARI', 14, yPos);
        yPos += 4;

        const skylightRows = data.skylights.map(s => [
            s.name,
            s.qty,
            s.schema,
            isExternalSchema(s.schema) ? 'COPERPLAX' : s.netType.toUpperCase(),
            s.luce + ' cm',
            s.lunghezza + ' m',
            'H.' + s.hRete,
            s.lTecnica.toFixed(3) + ' m'
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['Nome', 'Qtà', 'Schema', 'Tipo', 'Largh.', 'Lungh.', 'H Rete', 'L Tecnica']],
            body: skylightRows,
            theme: 'grid',
            headStyles: { 
                fillColor: colorVerde, 
                textColor: 255,
                fontStyle: 'bold',
                halign: 'center'
            },
            bodyStyles: {
                halign: 'center',
                fontSize: 9
            },
            alternateRowStyles: {
                fillColor: [250, 250, 250]
            },
            columnStyles: {
                0: { halign: 'left', cellWidth: 32 }
            },
            styles: { fontSize: 9, cellPadding: 2 },
            margin: { left: 14, right: 14 }
        });

        yPos = doc.lastAutoTable.finalY + 10;
        
        // ================================================================
        // DISTINTA RETI
        // ================================================================
        
        if (Object.keys(data.bom.reti).length > 0) {
            doc.setFontSize(12);
            doc.setTextColor(...colorVerde);
            doc.setFont('helvetica', 'bold');
            doc.text('DISTINTA RETI', 14, yPos);
            yPos += 4;

            const retiRows = Object.values(data.bom.reti).map(item => {
                const p = item.product;
                return [
                    item.code, 
                    p?.desc || '', 
                    item.qty + ' rot.',
                    formatCurrency(p?.price || 0), 
                    formatCurrency(item.qty * (p?.price || 0))
                ];
            });

            doc.autoTable({
                startY: yPos,
                head: [['Codice', 'Descrizione', 'Qtà', 'Prezzo', 'Totale']],
                body: retiRows,
                theme: 'grid',
                headStyles: { 
                    fillColor: colorVerde,
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [250, 250, 250]
                },
                columnStyles: {
                    0: { cellWidth: 28 },
                    1: { cellWidth: 70 },
                    2: { halign: 'center', cellWidth: 20 },
                    3: { halign: 'right', cellWidth: 25 },
                    4: { halign: 'right', cellWidth: 28 }
                },
                styles: { fontSize: 9, cellPadding: 2 },
                margin: { left: 14, right: 14 }
            });
            yPos = doc.lastAutoTable.finalY + 10;
        }
        
        // ================================================================
        // DISTINTA ACCESSORI
        // ================================================================
        
        const allAccessori = [
            ...Object.values(data.bom.interno || {}),
            ...Object.values(data.bom.esterno || {}),
            ...Object.values(data.bom.giunzione || {})
        ];

        if (allAccessori.length > 0) {
            // Check se serve nuova pagina
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(12);
            doc.setTextColor(...colorBlu);
            doc.setFont('helvetica', 'bold');
            doc.text('DISTINTA ACCESSORI', 14, yPos);
            yPos += 4;

            const accRows = allAccessori.map(item => {
                const p = item.product;
                const nConf = item.isMeters ? Math.ceil(item.qty / (p?.rollLength || 25)) : Math.ceil(item.qty / (p?.pcs || 1));
                return [
                    item.code, 
                    p?.desc || '', 
                    nConf,
                    formatCurrency(nConf * (p?.price || 0))
                ];
            });

            doc.autoTable({
                startY: yPos,
                head: [['Codice', 'Descrizione', 'N° Conf.', 'Totale']],
                body: accRows,
                theme: 'grid',
                headStyles: { 
                    fillColor: colorBlu,
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [250, 250, 250]
                },
                columnStyles: {
                    0: { cellWidth: 28 },
                    1: { cellWidth: 95 },
                    2: { halign: 'center', cellWidth: 22 },
                    3: { halign: 'right', cellWidth: 28 }
                },
                styles: { fontSize: 9, cellPadding: 2 },
                margin: { left: 14, right: 14 }
            });
            yPos = doc.lastAutoTable.finalY + 12;
        }
        
        // ================================================================
        // RIEPILOGO TOTALI
        // ================================================================
        
        // Check se serve nuova pagina
        if (yPos > 230) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(12);
        doc.setTextColor(...colorVerde);
        doc.setFont('helvetica', 'bold');
        doc.text('RIEPILOGO TOTALI', 14, yPos);
        yPos += 8;

        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.setFont('helvetica', 'normal');
        
        const totaliData = [
            ['Reti:', data.totali.listinoReti, '->', data.totali.scontatoReti],
            ['Accessori Interno:', data.totali.listinoInterno, '->', data.totali.scontatoInterno],
            ['Accessori Esterno:', data.totali.listinoEsterno, '->', data.totali.scontatoEsterno],
            ['Accessori Giunzione:', data.totali.listinoGiunzione, '->', data.totali.scontatoGiunzione]
        ];
        
        totaliData.forEach(row => {
            doc.text(row[0], 14, yPos);
            doc.text(`${row[1]} ${row[2]} ${row[3]}`, 60, yPos);
            yPos += 6;
        });
        
        yPos += 4;
        
        // Box finale verde per totale
        doc.setFillColor(...colorVerde);
        doc.roundedRect(14, yPos - 2, pageWidth - 28, 14, 2, 2, 'F');
        
        doc.setFontSize(14);
        doc.setTextColor(255);
        doc.setFont('helvetica', 'bold');
        doc.text(`TOTALE FINALE: ${data.totali.totaleFinale}`, 18, yPos + 8);
        
        // ================================================================
        // FOOTER
        // ================================================================
        
        // Linea footer
        doc.setDrawColor(...colorGrigio);
        doc.setLineWidth(0.3);
        doc.line(14, pageHeight - 18, pageWidth - 14, pageHeight - 18);
        
        doc.setFontSize(8);
        doc.setTextColor(...colorGrigio);
        doc.setFont('helvetica', 'normal');
        doc.text('Cavatorta SpA - Preventivo generato da Configuratore Copertec System v3.1', 14, pageHeight - 12);
        doc.text('Prezzi da listino. Verificare giacenze e conferma d\'ordine.', 14, pageHeight - 7);
        
        // Numero pagina
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(...colorGrigio);
            doc.text(`Pag. ${i}/${totalPages}`, pageWidth - 25, pageHeight - 7);
        }

        // Download
        const filename = `Preventivo_Copertec_${data.cliente.ragioneSociale.replace(/\s+/g, '_')}_${data.cliente.data}.pdf`;
        doc.save(filename);
    }

    function exportExcel() {
        // Verifica se XLSX è disponibile
        if (typeof XLSX === 'undefined') {
            alert('La libreria Excel non è disponibile in questa modalità di visualizzazione.\n\nPer scaricare l\'Excel:\n1. Salva il file HTML sul tuo computer\n2. Aprilo nel browser\n3. Riprova il download');
            return;
        }
        
        const data = getExportData();
        const wb = XLSX.utils.book_new();

        // Sheet 1: Riepilogo Preventivo
        const riepilogoData = [
            ['PREVENTIVO COPERTEC SYSTEM - RIEPILOGO'],
            [''],
            ['DATI CLIENTE'],
            ['Cliente', data.cliente.ragioneSociale],
            ['Referente', data.cliente.referente],
            ['Email', data.cliente.email],
            ['Telefono', data.cliente.telefono],
            ['Progetto', data.cliente.progetto],
            ['Data', data.cliente.data],
            [''],
            ['RIEPILOGO PREZZI', 'Listino', 'Sconto %', 'Netto'],
            ['Reti', data.totali.listinoReti, data.totali.scontoRetiPerc, data.totali.scontatoReti],
            ['Accessori Interno', data.totali.listinoInterno, data.totali.scontoInternoPerc, data.totali.scontatoInterno],
            ['Accessori Esterno', data.totali.listinoEsterno, data.totali.scontoEsternoPerc, data.totali.scontatoEsterno],
            ['Accessori Giunzione', data.totali.listinoGiunzione, data.totali.scontoGiunzionePerc, data.totali.scontatoGiunzione],
            [''],
            ['TOTALE LISTINO', data.totali.totaleListino],
            ['SCONTO TOTALE', data.totali.scontoTotale],
            ['TOTALE FINALE', '', '', data.totali.totaleFinale],
        ];
        const wsRiepilogo = XLSX.utils.aoa_to_sheet(riepilogoData);
        wsRiepilogo['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 12 }, { wch: 15 }];
        XLSX.utils.book_append_sheet(wb, wsRiepilogo, 'Riepilogo');

        // Sheet 2: Lucernari
        const lucernariHeader = ['Nome', 'Qtà', 'Schema', 'Tipo Rete', 'Larghezza (cm)', 'Lunghezza (m)', 'H Rete (cm)', 'L Tecnica (m)', 'Passo Fissaggi (cm)'];
        const lucernariData = data.skylights.map(s => [
            s.name,
            s.qty,
            s.schema,
            isExternalSchema(s.schema) ? 'COPERPLAX' : s.netType.toUpperCase(),
            s.luce,
            s.lunghezza,
            s.hRete,
            s.lTecnica.toFixed(3),
            s.spacing || '-'
        ]);
        const wsLucernari = XLSX.utils.aoa_to_sheet([lucernariHeader, ...lucernariData]);
        wsLucernari['!cols'] = [{ wch: 18 }, { wch: 6 }, { wch: 8 }, { wch: 12 }, { wch: 14 }, { wch: 14 }, { wch: 12 }, { wch: 12 }, { wch: 16 }];
        XLSX.utils.book_append_sheet(wb, wsLucernari, 'Lucernari');

        // Sheet 3: BOM Completo con prezzi scontati
        const discounts = {
            reti: [parseFloat(document.getElementById('discReti1').value) || 0, parseFloat(document.getElementById('discReti2').value) || 0],
            interno: [parseFloat(document.getElementById('discInterno1').value) || 0, parseFloat(document.getElementById('discInterno2').value) || 0],
            esterno: [parseFloat(document.getElementById('discEsterno1').value) || 0, parseFloat(document.getElementById('discEsterno2').value) || 0],
            giunzione: [parseFloat(document.getElementById('discGiunzione1').value) || 0, parseFloat(document.getElementById('discGiunzione2').value) || 0],
        };

        function calcScontoPerc(d) {
            return (1 - (1 - d[0]/100) * (1 - d[1]/100)) * 100;
        }

        function applyDiscountExcel(amount, d) {
            return amount * (1 - d[0]/100) * (1 - d[1]/100);
        }

        const bomHeader = ['Codice', 'Qtà', 'Descrizione', 'Conf.', 'N° Conf.', 'Prezzo Unit.', 'Tot. Listino', 'Sconto %', 'Tot. Netto'];
        const bomData = [];

        // Reti
        Object.values(data.bom.reti || {}).forEach(item => {
            const p = item.product;
            if (!p) return;
            const totListino = item.qty * p.price;
            const scontoPerc = calcScontoPerc(discounts.reti);
            const totNetto = applyDiscountExcel(totListino, discounts.reti);
            bomData.push([item.code, item.qty + ' rot.', p.desc, '25m', item.qty, p.price.toFixed(2), totListino.toFixed(2), scontoPerc.toFixed(1) + '%', totNetto.toFixed(2)]);
        });

        // Accessori Interno
        Object.values(data.bom.interno || {}).forEach(item => {
            const p = item.product;
            if (!p) return;
            let nConf, confDesc, qtaDesc;
            if (item.isMeters) {
                nConf = Math.ceil(item.qty / p.rollLength);
                confDesc = p.rollLength + 'm';
                qtaDesc = item.qty.toFixed(1) + 'm';
            } else {
                nConf = Math.ceil(item.qty / p.pcs);
                confDesc = p.pcs + 'pz';
                qtaDesc = Math.ceil(item.qty) + 'pz';
            }
            const totListino = nConf * p.price;
            const scontoPerc = calcScontoPerc(discounts.interno);
            const totNetto = applyDiscountExcel(totListino, discounts.interno);
            bomData.push([item.code, qtaDesc, p.desc, confDesc, nConf, p.price.toFixed(2), totListino.toFixed(2), scontoPerc.toFixed(1) + '%', totNetto.toFixed(2)]);
        });

        // Accessori Esterno
        Object.values(data.bom.esterno || {}).forEach(item => {
            const p = item.product;
            if (!p) return;
            const nConf = Math.ceil(item.qty / p.pcs);
            const totListino = nConf * p.price;
            const scontoPerc = calcScontoPerc(discounts.esterno);
            const totNetto = applyDiscountExcel(totListino, discounts.esterno);
            bomData.push([item.code, Math.ceil(item.qty) + 'pz', p.desc, p.pcs + 'pz', nConf, p.price.toFixed(2), totListino.toFixed(2), scontoPerc.toFixed(1) + '%', totNetto.toFixed(2)]);
        });

        // Accessori Giunzione
        Object.values(data.bom.giunzione || {}).forEach(item => {
            const p = item.product;
            if (!p) return;
            const nConf = Math.ceil(item.qty / p.pcs);
            const totListino = nConf * p.price;
            const scontoPerc = calcScontoPerc(discounts.giunzione);
            const totNetto = applyDiscountExcel(totListino, discounts.giunzione);
            bomData.push([item.code, Math.ceil(item.qty) + 'pz', p.desc, p.pcs + 'pz', nConf, p.price.toFixed(2), totListino.toFixed(2), scontoPerc.toFixed(1) + '%', totNetto.toFixed(2)]);
        });

        const wsBom = XLSX.utils.aoa_to_sheet([bomHeader, ...bomData]);
        wsBom['!cols'] = [{ wch: 13 }, { wch: 10 }, { wch: 32 }, { wch: 8 }, { wch: 8 }, { wch: 11 }, { wch: 12 }, { wch: 9 }, { wch: 12 }];
        XLSX.utils.book_append_sheet(wb, wsBom, 'Distinta Materiali');

        // Download
        const filename = `Preventivo_Copertec_${data.cliente.ragioneSociale.replace(/\s+/g, '_')}_${data.cliente.data}.xlsx`;
        XLSX.writeFile(wb, filename);
    }

    function exportWhatsApp() {
        const data = getExportData();
        
        let message = `*PREVENTIVO COPERTEC SYSTEM*\n`;
        message += `_Reti Anticaduta CNR A.T. 650/25_\n\n`;
        
        message += `*CLIENTE:* ${data.cliente.ragioneSociale}\n`;
        if (data.cliente.progetto) message += `*PROGETTO:* ${data.cliente.progetto}\n`;
        message += `*DATA:* ${data.cliente.data}\n\n`;
        
        message += `*CONFIGURAZIONE LUCERNARI:*\n`;
        data.skylights.forEach((s, i) => {
            const netType = isExternalSchema(s.schema) ? 'COPERPLAX' : s.netType.toUpperCase();
            message += `${i+1}. ${s.name}\n`;
            message += `   Qtà: ${s.qty} | Schema: ${s.schema} | ${netType}\n`;
            message += `   Luce: ${s.luce}cm | Lungh: ${s.lunghezza}m | H.${s.hRete}cm\n\n`;
        });
        
        message += `*DISTINTA RETI:*\n`;
        Object.values(data.bom.reti || {}).forEach(item => {
            const p = item.product;
            if (p) message += `* ${item.qty} rotoli ${p.desc}\n`;
        });
        
        message += `\n*DISTINTA ACCESSORI:*\n`;
        const allAcc = [...Object.values(data.bom.interno || {}), ...Object.values(data.bom.esterno || {}), ...Object.values(data.bom.giunzione || {})];
        allAcc.forEach(item => {
            const p = item.product;
            if (p) {
                let qtaText, confText;
                if (item.isMeters) {
                    const nConf = Math.ceil(item.qty / p.rollLength);
                    qtaText = `${item.qty.toFixed(1)}m`;
                    confText = `${nConf} conf. da ${p.rollLength}m`;
                } else {
                    const nConf = Math.ceil(item.qty / p.pcs);
                    qtaText = `${Math.ceil(item.qty)} pz`;
                    confText = `${nConf} conf. da ${p.pcs}pz`;
                }
                message += `* ${p.desc}\n   ${qtaText} → ${confText}\n`;
            }
        });
        
        message += `\n*RIEPILOGO PREZZI:*\n`;
        message += `Listino: ${data.totali.totaleListino}\n`;
        message += `Sconto: ${data.totali.scontoTotale}\n`;
        message += `*TOTALE NETTO: ${data.totali.totaleFinale}*\n\n`;
        
        message += `_Preventivo generato con Configuratore Copertec_\n`;
        message += `_Cavatorta SpA - Verificare giacenze_`;

        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
        window.open(whatsappUrl, '_blank');
    }

    function exportEmail() {
        const data = getExportData();
        
        const subject = `Preventivo Copertec System - ${data.cliente.ragioneSociale} - ${data.cliente.data}`;
        
        let body = `PREVENTIVO COPERTEC SYSTEM\n\n`;
        body += `Cliente: ${data.cliente.ragioneSociale}\n`;
        body += `Referente: ${data.cliente.referente}\n`;
        body += `Progetto: ${data.cliente.progetto}\n`;
        body += `Data: ${data.cliente.data}\n\n`;
        
        body += `LUCERNARI CONFIGURATI:\n`;
        data.skylights.forEach(s => {
            body += `- ${s.name}: ${s.qty}x Schema ${s.schema}, Largh. ${s.luce}cm, Lungh. ${s.lunghezza}m, H.${s.hRete}\n`;
        });
        
        body += `\nRIEPILOGO:\n`;
        body += `Reti: ${data.totali.scontatoReti}\n`;
        body += `Accessori Interno: ${data.totali.scontatoInterno}\n`;
        body += `Accessori Esterno: ${data.totali.scontatoEsterno}\n`;
        body += `Accessori Giunzione: ${data.totali.scontatoGiunzione}\n\n`;
        body += `TOTALE FINALE: ${data.totali.totaleFinale}\n\n`;
        body += `---\nPreventivo generato da Configuratore Copertec System v3.0\nCavatorta SpA\nVerificare giacenze prima dell'ordine.`;

        const mailto = `mailto:${data.cliente.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailto;
    }

    // ================================================================
    // INIT
    // ================================================================

    document.addEventListener('DOMContentLoaded', () => {
        initDate();
        addSkylight();
    });
    </script>
</body>
</html>
